## Part 1: 产品需求文档 (PRD)

### 1. 产品名称
*   **暂定名:** MoliTodo / 悬浮待办
*   **一句话简介:** 一款常驻在桌面边缘的悬浮式待办事项应用，旨在提供最快速的任务查看和添加体验。

#### 2. 产品概述
当前用户在处理待办事项时，通常需要打开一个独立的应用程序窗口，这会打断当前的工作流。MoliTodo 通过一个可自定义位置的悬浮图标，将核心信息与操作入口始终置于用户视线可及之处。用户无需切换应用，即可快速管理每日任务，并通过醒目的提醒动画，确保重要事项不会被遗漏。

*   **目标用户:**
    *   需要轻量级任务提醒的 Mac 用户。
    *   程序员、设计师、学生等需要长时间聚焦于屏幕工作，但希望有简便方式记录临时想法和任务的人群。
*   **核心价值:**
    *   **无缝集成:** 不打断当前工作流，与桌面环境融为一体。
    *   **即时提醒:** 通过角标和动画提供直观、强烈的任务提醒。
    *   **快速操作:** 悬浮即可查看，输入即是添加，操作路径极短。

### 3. 功能详述 (Features)

#### 3.1 核心组件：悬浮图标 (Floating Icon)**
*   **3.1.1 常驻显示:**
    *   **需求:** 应用启动后，一个圆形图标会出现在屏幕上，并始终保持在所有窗口的最前端。
    *   **交互:** 用户可以按住图标拖动，将其放置在屏幕任意位置。应用应记录用户最后一次放置的位置，下次启动时恢复。
*   **3.1.2 任务角标 (Badge):**
    *   **需求:** 图标右上角会以红色小圆点的形式显示当前“未完成”的任务数量。
    *   **规则:**
        *   任务数 > 0 时，显示数字。
        *   任务数 = 0 时，角标不显示。
        *   任务数 > 99 时，显示 "99+"。
*   **3.1.3 提醒状态 (Alert State):**
    *   **需求:** 当有任务到达预设的提醒时间，悬浮图标会进入“提醒状态”。
    *   **表现:**
        1.  图标图案从默认样式（如对勾✓或应用Logo）变为“闹钟”图标。
        2.  图标背景色变为醒目的红色。
        3.  图标会进行轻微的、循环的“跳动”或“摇晃”动画，以吸引用户注意。
    *   **退出提醒:** 用户将鼠标悬浮在图标上，打开任务面板后，提醒状态（动画和颜色）恢复为常规状态。

**3.2 核心组件：任务面板 (Popover)**
*   **3.2.1 触发方式:**
    *   **需求:** 当鼠标光标悬浮 (Hover) 在悬浮图标上时，一个简洁的面板会从图标旁弹出。
    *   **交互:** 鼠标移开图标和面板区域后，面板自动消失。
*   **3.2.2 任务列表 (Task List):**
    *   **需求:** 面板中展示所有“未完成”的任务列表。
    *   **元素:**
        *   **复选框 (Checkbox):** 位于任务左侧，点击后将任务标记为“已完成”。已完成的任务应立即从列表中移除（或带有删除线并移动到底部），同时悬浮图标上的角标数字减 1。
        *   **任务文本:** 显示任务的具体内容。
        *   **提醒时间:** 如果设置了提醒，以小字号显示在任务文本下方（例如: "今天 15:30"）。
        *   **删除按钮:** 鼠标悬浮在单条任务上时，右侧出现删除按钮，点击可直接删除该任务。
*   **3.2.3 快速添加框 (Quick Add Input):**
    *   **需求:** 面板顶部或底部有一个输入框，占位符文本为“添加新任务...”。
    *   **交互:**
        *   用户在输入框中输入内容后，按 `Enter` 键即可创建一条新任务。
        *   新任务被添加到任务列表的顶部，输入框清空并重新聚焦，方便连续添加。
        *   悬浮图标上的角标数字加 1。
*   **3.2.4 提醒设置:**
    *   **需求:** 用户可以为每条任务设置提醒时间。
    *   **交互:** 点击任务列表中的某一条任务（非复选框区域），会展开一个简易的日期和时间选择器。用户设置完毕后，提醒时间会显示在该任务下方。


#### 3.3 入口与窗口管理 (新增章节)

*   **3.3.1 系统托盘/菜单栏图标 (Entry Point):**
    *   **需求:** 除了悬浮图标外，应用在启动后，还应在系统的菜单栏 (macOS) 或系统托盘 (Windows) 中显示一个常驻的应用图标。这个图标是访问设置和执行主要操作的入口。
    *   **交互:**
        *   **左键单击:** 弹出上下文菜单。
        *   **右键单击:** (在 Windows 上) 同样弹出上下文菜单。
    *   **菜单项:**
        *   `显示/隐藏悬浮图标` (一个可勾选的选项)
        *   `设置...` (点击后打开设置窗口)
        *   `查看已完成任务...` (点击后打开历史记录窗口)
        *   `---` (分割线)
        *   `关于 MoliTodo`
        *   `退出 MoliTodo`

*   **3.3.2 窗口行为:**
    *   **需求:** “设置”和“历史记录”是两个独立的标准窗口。
    *   **交互:**
        *   点击菜单中的“设置...”，如果设置窗口未打开，则打开并显示在最前端；如果已打开，则将其带到最前端。
        *   历史记录窗口同理。
        *   关闭窗口（点击红色关闭按钮）只是隐藏窗口，并不会退出应用。用户需要通过菜单栏/托盘图标的“退出”选项来完全关闭应用。

#### 3.4 设置窗口 (原 3.3.3 扩展)

*   **3.4.1 窗口设计:**
    *   **需求:** 一个独立的、带标题栏的标准窗口，标题为“设置”。窗口内建议使用标签页 (Tabs) 来组织不同类别的设置项。
    *   **建议标签页:** `通用`、`外观`、`通知`。

*   **3.4.2 通用设置 (General Tab):**
    *   **开机自启动 (Launch at Login):**
        *   **UI:** 一个复选框或拨动开关。
        *   **标签:** `开机时自动启动 MoliTodo`。
        *   **交互:** 用户勾选/取消勾选后，设置立即生效。
    *   **数据管理 (Data Management):**
        *   **UI:** 一组按钮。
        *   **功能:**
            *   `导出数据...`: 点击后弹出文件保存对话框，允许用户将所有任务数据（包括未完成和已完成的）导出为一个 `.json` 文件。
            *   `导入数据...`: 点击后弹出文件打开对话框，允许用户选择一个之前导出的 `.json` 文件来覆盖当前数据。导入前应有弹窗二次确认：“这将覆盖您当前的所有任务，确定要继续吗？”。
            *   `清除所有数据`: 点击后弹窗二次确认：“此操作将永久删除所有未完成和已完成的任务且无法恢复，确定要清除吗？”。

*   **3.4.3 外观设置 (Appearance Tab):**
    *   **悬浮图标调整 (Floating Icon Customization):**
        *   **UI:** 两个滑块 (Slider)。旁边应有实时显示的数值。
        *   **功能:**
            *   `透明度 (Opacity)`: 滑块范围 20% - 100%。当用户拖动滑块时，桌面上的悬浮图标应**实时**改变其透明度，提供即时预览。
            *   `大小 (Size)`: 滑块范围 40px - 80px。同样，当用户拖动时，悬浮图标应**实时**改变大小。
    *   **主题 (Theme) (可选高级功能):**
        *   **UI:** 一组单选按钮。
        *   **选项:**
            *   `亮色模式图标`
            *   `暗色模式图标`
            *   `跟随系统` (默认)
        *   **交互:** 选择后，悬浮图标的默认配色方案会相应改变。

*   **3.4.4 通知设置 (Notifications Tab):**
    *   **提醒声音 (Alert Sound):**
        *   **UI:** 一个下拉菜单和一个“播放”按钮。
        *   **选项:**
            *   `无 (Mute)`
            *   `系统默认`
            *   `钟声 (Chime)` (应用内置音效)
            *   `数字铃声 (Digital)` (应用内置音效)
        *   **交互:** 用户选择一个声音后，可以点击旁边的“播放”按钮试听。设置保存后，任务提醒将使用此声音。
    *   **系统通知 (System Notifications):**
        *   **UI:** 一个复选框或拨动开关。
        *   **标签:** `任务到达提醒时间时，发送桌面通知`。
        *   **交互:** 默认开启。关闭后，任务到期将只有悬浮图标的动画提醒，而不会弹出系统级的通知横幅。

#### 3.5 历史记录窗口 (原 3.3.3 “查看已完成任务”扩展)

*   **3.5.1 窗口设计:**
    *   **需求:** 一个独立的、带标题栏的标准窗口，标题为“已完成的任务”。
    *   **布局:**
        *   顶部是搜索框和操作按钮。
        *   主体是已完成任务的列表。

*   **3.5.2 功能与交互:**
    *   **任务列表 (Completed Task List):**
        *   **显示内容:** 每条任务应显示 `任务内容` 和 `完成时间` (例如：“2023年10月27日 15:30”)。
        *   **分组与排序:** 列表应按**完成时间倒序排列**（最新的在最上面）。为了更好的可读性，可以按日期进行分组，例如显示“今天”、“昨天”、“本周早些时候”等副标题。
    *   **搜索与筛选 (Search & Filter):**
        *   **UI:** 窗口顶部有一个搜索框。
        *   **交互:** 用户输入关键词后，列表会实时筛选出任务内容包含该关键词的已完成任务。
    *   **任务操作 (Task Actions):**
        *   **UI:** 当鼠标悬浮在单条任务上时，右侧出现操作按钮。
        *   **功能:**
            *   `恢复 (Restore)`: 点击后，该任务会从“已完成列表”中移除，并重新出现在主悬浮窗的“未完成列表”中。悬浮图标的角标数字会相应加 1。
            *   `永久删除 (Delete Permanently)`: 点击后，弹窗二次确认：“确定要永久删除这条任务吗？”，确认后将任务从数据库中彻底移除。
    *   **批量操作 (Bulk Actions):**
        *   **UI:** 窗口右上角或底部有一个“清除全部”按钮。
        *   **功能:** `清除所有历史记录`: 点击后，弹窗二次确认：“此操作将永久删除所有已完成的任务且无法恢复，确定吗？”，确认后清空整个已完成任务列表。

---

### Part 2: 项目执行步骤

这是一个从 0 到 1 的敏捷开发路径，建议分阶段完成。

**阶段一：MVP (最小可行产品) - 验证核心玩法**
*   **目标:** 实现最核心的悬浮、添加、显示功能。
1.  **步骤 1: 创建基础应用。**
    *   创建一个无主窗口的 macOS 应用。
    *   实现一个可以拖动的、始终在顶层的悬浮图标。
2.  **步骤 2: 实现任务面板。**
    *   实现鼠标悬浮在图标上时，弹出 Popover。
    *   在 Popover 中加入一个简单的输入框和任务列表（此时任务列表可以是临时的内存数据）。
3.  **步骤 3: 实现核心逻辑。**
    *   在输入框按回车，可以将任务添加到列表中。
    *   实现悬浮图标上的角标数字与任务数量同步。
4.  **步骤 4: 实现数据持久化。**
    *   将任务数据存储到本地文件（如 JSON 或 Plist），实现应用重启后数据不丢失。

**阶段二：完善核心功能**
*   **目标:** 让应用变得真正“可用”。
5.  **步骤 5: 实现任务管理。**
    *   为每条任务添加复选框，实现“完成”功能，并更新角标。
    *   为每条任务添加删除按钮。
6.  **步骤 6: 实现提醒系统。**
    *   为任务添加设置提醒时间的 UI（日期时间选择器）。
    *   使用系统API，在到达指定时间时触发一个动作。
7.  **步骤 7: 实现提醒状态。**
    *   当提醒被触发，实现悬浮图标变色、变图案、播放动画的效果。
    *   同时，发送一条 macOS 系统通知。

**阶段三：优化和发布**
*   **目标:** 提升用户体验，准备上线。
8.  **步骤 8: 增加设置项。**
    *   在菜单栏添加一个图标，点击后可以打开设置窗口。
    *   实现“开机自启动”功能。
9.  **步骤 9: UI/UX 优化。**
    *   打磨图标、面板的视觉设计。
    *   添加平滑的动画效果（如面板弹出、列表增删）。
10. **步骤 10: 全面测试和 Bug 修复。**
    *   测试各种边缘情况（如任务过多、频繁操作等）。
    *   优化性能，确保低 CPU 和内存占用。
11. **步骤 11: 准备部署。**
    *   设计应用图标。
    *   打包、签名、公证。

---

### Part 3: 开发与部署方案

#### 1. 技术选型
*   **开发语言: Swift**
    *   这是苹果生态开发的首选语言，现代、安全、高效。
*   **UI 框架: SwiftUI**
    *   强烈推荐使用 SwiftUI。它的声明式语法非常适合构建你描述的这种动态、响应式的 UI。无论是 Popover、任务列表还是角标，用 SwiftUI 实现都非常简洁。
    *   对于一些 SwiftUI 不易实现的高级窗口操作（如创建无边框、可穿透的悬浮窗），可能需要桥接 AppKit (`NSWindow`) 来辅助。这是一个成熟的混合开发方案。
*   **开发工具: Xcode**
    *   苹果官方的集成开发环境 (IDE)，是 macOS 和 iOS 开发的唯一选择。
*   **数据存储: Core Data 或 SwiftData**
    *   **SwiftData:** 如果你的目标是较新的 macOS 版本 (Sonoma+)，SwiftData 是 SwiftUI 的最佳搭档，非常易用。
    *   **Core Data:** 苹果成熟的对象图谱和持久化框架，功能强大，学习曲线稍高。
    *   **简单方案:** 对于 MVP 阶段，甚至可以直接用 `Codable` 协议将任务数组编码成 JSON，存储在本地文件中。

#### 2. 关键技术点实现思路
*   **悬浮图标 (Floating Icon):**
    *   你需要创建一个自定义的 `NSWindow`。
    *   设置其 `styleMask` 为 `.borderless`（无边框）。
    *   设置 `isOpaque` 为 `false`，`backgroundColor` 为 `.clear`（背景透明）。
    *   设置 `level` 为 `.floating` 或更高，使其保持在顶层。
    *   设置 `ignoresMouseEvents` 为 `true`，但将其 `contentView` 的此属性设为 `false`，这样只有图标本身能响应事件，窗口的透明区域可以“穿透”。
    *   在 SwiftUI 中，你可以通过 `NSHostingView` 将你的 SwiftUI 视图（那个带角标的图标）放入这个自定义的 `NSWindow` 中。
*   **悬浮面板 (Popover):**
    *   SwiftUI 的 `.popover` 修饰符可以轻松实现。你可以将其绑定到一个状态变量，通过监听鼠标的 `onHover` 事件来控制这个状态变量的真假，从而控制 Popover 的显示和隐藏。
*   **提醒和后台任务 (Reminders):**
    *   使用 `UserNotifications` 框架。通过 `UNUserNotificationCenter.current().add(request)` 来注册一个本地通知。你可以设置 `trigger` 为 `UNCalendarNotificationTrigger`，并指定一个未来的日期和时间。
*   **开机自启动:**
    *   使用苹果推荐的 `SMAppService` API (适用于较新的 macOS) 或旧版的 `SMLoginItemSetEnabled`。

#### 3. 部署方案
1.  **本地测试:** 直接在 Xcode 中运行和调试。
2.  **分发给朋友测试 (Ad-Hoc):**
    *   在 Xcode 中选择 "Archive"。
    *   在 "Organizer" 窗口中，选择 "Distribute App" -> "Copy App"，导出一个 `.app` 文件，可以直接发给朋友（他们的 Mac 可能需要调整安全设置才能打开）。
3.  **正式发布:**
    *   **选项A: Mac App Store (推荐)**
        *   **优点:** 可信度高，用户易于发现和安装，更新方便。
        *   **要求:**
            *   注册 Apple Developer Program (\$99/年)。
            *   应用必须经过沙盒化 (App Sandbox)，限制其对系统文件的访问，更安全。
            *   遵循 App Store 的审核指南。
            *   通过 Xcode 将应用上传到 App Store Connect 进行审核和发布。
    *   **选项B: 独立分发 (网站下载)**
        *   **优点:** 无需审核，发布自由，没有平台抽成。
        *   **要求:**
            *   同样需要 Apple Developer Program 账号来获取开发者 ID 证书。
            *   你需要对应用进行签名 (Code Signing) 和公证 (Notarization)。公证是苹果的一项自动安全检查，通过后，用户在 macOS上打开你的应用时就不会看到“无法验证开发者”的可怕警告。
            *   通常将 `.app` 文件打包成 `.dmg` 磁盘映像文件，方便用户下载和安装。

**总结建议:**
从你的想法来看，这是一个非常适合独立开发者练手并发布的小而美项目。建议你**从 MVP 开始，使用 Electron 的技术栈，快速迭代**。当核心功能稳定后，再考虑上架 Mac App Store，让更多人使用你的作品。祝你开发顺利！

---

## 自动构建和发布

本项目配置了 GitHub Actions 自动构建工作流，支持在推送版本标签时自动构建 macOS 和 Windows 应用程序。

### 快速发布新版本

```bash
# 更新版本号并创建标签
npm version patch  # 或 minor/major
git push origin main --tags
```

### 构建产物

- **macOS Intel**: `MoliTodo-{version}-x64.dmg` (适用于 Intel 芯片的 Mac)
- **macOS Apple Silicon**: `MoliTodo-{version}-arm64.dmg` (适用于 M1/M2/M3 芯片的 Mac)
- **Windows**: `MoliTodo Setup {version}.exe` (NSIS 安装程序)

详细的构建和发布指南请参考 [BUILD_GUIDE.md](BUILD_GUIDE.md)。