name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} 🚀
          
          ## 🎉 重大功能更新
          
          ### 🤖 AI 智能任务生成系统
          - **多 AI 提供商支持**: 集成 OpenAI、Google Gemini、Anthropic Claude、xAI Grok 四大主流 AI 提供商
          - **自定义 AI 配置**: 支持添加自定义 AI 提供商，满足企业和个人定制需求
          - **智能任务解析**: AI 可以将自然语言描述转换为结构化的任务列表
          - **批量任务生成**: 一次输入可生成多个相关任务，提高工作效率
          - **任务预览编辑**: 生成的任务支持预览和编辑，确保准确性后再批量创建
          
          ### ⚙️ AI 配置管理界面
          - **设置页面集成**: 在设置页面新增 AI 配置分类，提供完整的 AI 功能管理
          - **提供商选择**: 直观的 AI 提供商选择界面，支持实时配置状态显示
          - **连接测试**: 内置 AI 连接测试功能，确保配置正确性
          - **功能开关**: 支持独立控制各项 AI 功能的启用状态
          - **安全存储**: API 密钥等敏感信息安全存储，支持密码输入隐藏
          
          ### 💡 智能任务输入体验
          - **AI 模式切换**: 任务输入框集成 AI 开关，可随时启用或禁用 AI 功能
          - **实时模型选择**: 支持在任务创建时动态选择 AI 模型
          - **生成进度反馈**: AI 任务生成过程提供实时进度提示和加载状态
          - **错误降级**: AI 生成失败时自动回退到普通任务创建模式
          
          
          ## 🛠️ 技术改进
          
          - **AI 服务架构**: 新增统一的 AI 服务层，支持多提供商管理
          - **依赖库集成**: 引入 @ai-sdk 系列库，支持主流 AI 提供商
          - **安全机制**: 敏感配置信息的安全传输和存储机制
          - **性能优化**: AI 请求的防抖和缓存机制
          - **状态管理**: 扩展 taskStore 支持 AI 相关状态管理
          
          ## 📋 使用说明
          
          ### 配置 AI 功能
          1. 进入设置页面的"AI 配置"分类
          2. 选择合适的 AI 提供商（OpenAI、Google、Anthropic、xAI 或自定义）
          3. 输入相应的 API Key 和配置信息
          4. 点击"测试连接"验证配置正确性
          5. 启用所需的 AI 功能选项
          
          ### 使用 AI 生成任务
          1. 在任务输入框中点击 AI 图标启用 AI 模式
          2. 选择要使用的 AI 模型
          3. 输入自然语言描述的任务需求
          4. 按 Enter 键触发 AI 生成
          5. 在预览弹窗中编辑和确认生成的任务
          6. 点击"创建所有任务"完成批量添加
          
          ## 🔄 升级说明
          
          - **数据兼容**: 完全向后兼容，现有数据自动迁移
          - **AI 功能可选**: AI 功能为可选特性，不影响现有工作流程
          - **渐进式启用**: 用户可以根据需要选择性启用不同的 AI 功能
          - **配置独立**: AI 配置独立存储，不影响其他应用设置
          
          ## 📋 完整更新日志
          
          查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) 了解详细的更新内容。
          
          ---
          
          感谢使用 MoliTodo！AI 智能功能让任务管理更加高效便捷。如有问题或建议，欢迎在 GitHub 上反馈。
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md