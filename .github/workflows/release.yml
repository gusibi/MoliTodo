name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ✨
          
          ## 🎉 正式版本发布 - AI 报告生成系统重磅上线
          
          MoliTodo v1.0.0 正式版本隆重发布！这是一个具有里程碑意义的版本，标志着 MoliTodo 从简单的任务管理工具进化为智能化的工作效率助手。
          
          ### 🤖 AI 智能报告生成系统 (AI Report Generation System)
          
          #### 核心功能特性
          - **一键生成工作报告**: 基于现有强大的 AI 基础设施，新增智能报告生成功能
          - **多AI提供商支持**: 利用 OpenAI、Google Gemini、Anthropic Claude、xAI Grok 等顶级 AI 服务
          - **智能内容分析**: AI 深度分析任务状态、时间分布、完成情况，生成专业级工作报告
          - **自定义报告模板**: 支持个性化的日报和周报模板配置，满足不同工作场景需求
          - **Markdown 格式输出**: 生成结构化的 Markdown 格式报告，易于分享和存档
          
          #### 智能特性亮点
          - **时间筛选集成**: AI 报告按钮无缝集成到时间筛选组件，基于当前筛选上下文生成相应报告
          - **智能报告类型判断**: 根据筛选条件自动判断生成日报还是周报
          - **任务状态精准识别**: 基于任务的 status 字段精确判断任务状态和进度
          - **一键复制功能**: 生成的报告支持一键复制到剪贴板，便于即时使用
          - **加载状态反馈**: 完善的加载动画和状态提示，确保用户体验流畅
          
          ### 🎯 1.0.0 里程碑意义
          
          #### 功能生态系统完善
          - **AI 生态闭环**: 从任务创建到报告生成，形成完整的 AI 驱动工作流
          - **企业级应用**: 报告生成功能使应用具备企业级工作场景适用性
          - **智能工作助手**: 从简单任务管理进化为智能化工作效率助手
          - **行业领先地位**: 在任务管理应用中率先实现智能报告生成
          
          #### 技术架构成熟度
          - **微服务化实现**: 报告服务的独立化体现了架构的成熟
          - **扩展性基础**: 为未来更多 AI 功能奠定了坚实基础
          - **稳定性保证**: 经过多个版本迭代，架构稳定可靠
          - **性能优化**: 达到企业级应用的性能要求
          
          ## 📚 使用指南
          
          ### 快速开始
          1. **配置 AI 服务**: 在设置页面配置至少一个 AI 提供商
          2. **自定义模板**: （可选）在 AI 设置中自定义报告模板
          3. **筛选任务**: 使用时间筛选选择要分析的任务范围
          4. **生成报告**: 点击 AI 报告按钮，选择 AI 模型并生成
          5. **查看和复制**: 在弹窗中查看报告内容，一键复制使用
          
          ### 模板定制
          - **占位符语法**: 使用 `{{变量名}}` 语法定义动态内容位置
          - **支持变量**: `{{project_name}}`、`{{report_period}}`、`{{summary}}`、`{{completed_tasks}}` 等
          - **Markdown 格式**: 模板支持完整的 Markdown 语法格式化
          - **预览功能**: 配置过程中实时预览模板效果
          
          ## 🔄 升级说明
          
          ### 兼容性保证
          - **完全向后兼容**: 现有所有数据和配置完全保留
          - **AI 配置复用**: 利用现有 AI 配置，无需重新设置
          - **功能增强**: 在现有功能基础上新增报告功能，不影响原有工作流程
          - **即时可用**: 有 AI 配置的用户升级后立即可使用新功能
          
          ### 性能提升
          - **响应优化**: 改进 AI 调用的响应时间和用户反馈
          - **内存效率**: 优化报告生成过程的内存使用
          - **并发处理**: 优化多个报告生成请求的并发处理
          
          ## 🚀 未来展望
          
          v1.0.0 的发布标志着 MoliTodo 进入了新的发展阶段。基于这个强大的 AI 报告生成系统，我们将继续探索更多智能化功能：
          
          - **语音报告生成**: 通过语音指令快速生成报告
          - **团队协作报告**: 支持团队级别的协作报告生成
          - **数据可视化**: 将报告数据转化为图表和可视化内容
          - **预测性分析**: 基于历史数据的工作趋势预测
          
          ## 🙏 致谢
          
          感谢所有用户的支持和反馈，特别是那些积极使用 AI 功能并提供改进建议的用户。正是大家的参与和建议，使得 MoliTodo 能够不断进化，成为今天这样强大的智能工作助手。
          
          ---
          
          **立即体验**: [下载 MoliTodo v1.0.0](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }})  
          **功能文档**: [AI 报告生成使用指南](https://github.com/${{ github.repository }}/blob/main/docs/releases/v1.0.0.md)  
          **问题反馈**: [GitHub Issues](https://github.com/${{ github.repository }}/issues)  
          **社区讨论**: [开发者论坛](https://github.com/${{ github.repository }}/discussions)
          
          **MoliTodo v1.0.0 - 让智能成为工作效率的新标准！**
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md