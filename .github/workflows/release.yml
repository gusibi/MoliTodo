name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ðŸŽ‰
          
          ## ðŸŽ¯ æœ¬æ¬¡æ›´æ–°äº®ç‚¹

          **ðŸŽ‰ æ–°å¢žæ—¥è§†å›¾åŠŸèƒ½**
          - **ä¸“æ³¨å•æ—¥ç®¡ç†**: å…¨æ–°çš„æ—¥è§†å›¾æä¾›ä¸“æ³¨çš„å•æ—¥ä»»åŠ¡ç®¡ç†ä½“éªŒ
          - **æ—¶é—´æ®µå¸ƒå±€**: é‡‡ç”¨ä¸Žå‘¨è§†å›¾ä¸€è‡´çš„å››æ—¶æ®µå¸ƒå±€ï¼ˆä¸Šåˆã€ä¸‹åˆã€æ™šä¸Šã€å‡Œæ™¨ï¼‰
          - **æ™ºèƒ½å¯¼èˆª**: æ”¯æŒå‰ä¸€å¤©/åŽä¸€å¤©å¯¼èˆªï¼Œè½»æ¾æµè§ˆä¸åŒæ—¥æœŸçš„ä»»åŠ¡
          - **ä¸‰è§†å›¾åˆ‡æ¢**: æ”¯æŒæ—¥ã€å‘¨ã€æœˆä¸‰ç§è§†å›¾æ¨¡å¼çš„æ— ç¼åˆ‡æ¢

          **ðŸ“‹ ä»»åŠ¡è¯¦æƒ…å¼¹çª—**
          - **å®Œæ•´ä»»åŠ¡åˆ—è¡¨**: æœˆè§†å›¾ä¸­ç‚¹å‡»"æ›´å¤š"æŒ‰é’®æ˜¾ç¤ºå½“å¤©æ‰€æœ‰ä»»åŠ¡
          - **ä¼˜é›…å¼¹çª—è®¾è®¡**: ä½¿ç”¨æ¯›çŽ»ç’ƒæ•ˆæžœå’ŒåŠ¨ç”»ï¼Œæä¾›çŽ°ä»£åŒ–è§†è§‰ä½“éªŒ
          - **ä»»åŠ¡çŠ¶æ€å¯è§†åŒ–**: æ¸…æ™°æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆä»»åŠ¡ä½¿ç”¨åˆ é™¤çº¿æ•ˆæžœ
          - **å¤šç§å…³é—­æ–¹å¼**: æ”¯æŒç‚¹å‡»é®ç½©ã€å…³é—­æŒ‰é’®æˆ–æŒ‰ ESC é”®å…³é—­

          **âœ¨ è§†è§‰ä½“éªŒæå‡**
          - **ç»Ÿä¸€ä»Šæ—¥æ ‡è¯†**: æ‰€æœ‰è§†å›¾ä¸­çš„ä»Šæ—¥æ—¥æœŸéƒ½ä½¿ç”¨ä¸»é¢˜è‰²åœ†å½¢èƒŒæ™¯
          - **Font Awesome å›¾æ ‡**: ç»Ÿä¸€ä½¿ç”¨ Font Awesome å›¾æ ‡ï¼Œä¿æŒè§†è§‰ä¸€è‡´æ€§
          - **è‡ªå®šä¹‰æ»šåŠ¨æ¡**: å¼¹çª—ä½¿ç”¨ç»†è‡´çš„ä¸»é¢˜è‰²æ»šåŠ¨æ¡ï¼Œæå‡è§†è§‰ä½“éªŒ
          - **ä¼˜åŒ–å¸ƒå±€æ¯”ä¾‹**: æ—¥è§†å›¾é‡‡ç”¨ 1:7 çš„æ—¶é—´æ ‡ç­¾ä¸Žä»»åŠ¡åŒºåŸŸæ¯”ä¾‹

          **ðŸ› ï¸ æŠ€æœ¯æ”¹è¿›**
          - **ç»„ä»¶æž¶æž„ä¼˜åŒ–**: UnifiedCalendar ç»„ä»¶çŽ°åœ¨æ”¯æŒä¸‰ç§è§†å›¾æ¨¡å¼
          - **æ ·å¼ç³»ç»Ÿå®Œå–„**: CSS ç±»åŒ–ï¼Œä½¿ç”¨ä¸»é¢˜å˜é‡ç¡®ä¿è§†è§‰ä¸€è‡´æ€§
          - **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ï¼Œå®Œå–„äº‹ä»¶ç›‘å¬å™¨ç®¡ç†
          
          ## ðŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md