name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ğŸ‰
          
          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°äº®ç‚¹
          
          ### âœ¨ å‘¨è§†å›¾æ»šåŠ¨ä½“éªŒä¼˜åŒ–
          - **ç»Ÿä¸€æ»šåŠ¨è”åŠ¨**: æ—¶é—´åˆ—ä¸æ—¥æœŸå†…å®¹å®Œç¾åŒæ­¥æ»šåŠ¨
          - **éšè—æ»šåŠ¨æ¡**: å»é™¤æ»šåŠ¨æ¡è§†è§‰å¹²æ‰°ï¼Œå†…å®¹ä¸è¡¨å¤´å®Œç¾å¯¹é½
          - **ä»Šå¤©æ—¥æœŸçªå‡º**: åœ†å½¢èƒŒæ™¯æ ‡è¯†ä»Šå¤©æ—¥æœŸï¼Œä¸€ç›®äº†ç„¶
          - **å¸ƒå±€ç¨³å®šæ€§**: é˜²å‹ç¼©è®¾è®¡ï¼Œç¡®ä¿ç•Œé¢å…ƒç´ ä¸å˜å½¢
          
          ### ğŸ¨ è§†è§‰ä½“éªŒæå‡
          - èƒŒæ™¯è‰²ç»Ÿä¸€ï¼Œæ•´ä½“è§†è§‰æ›´åè°ƒ
          - å›ºå®šå°ºå¯¸è®¾è®¡ï¼Œåˆ‡æ¢å‘¨æ—¶ç•Œé¢é«˜åº¦ä¿æŒç¨³å®š
          - ä¸»é¢˜è‰²é›†æˆï¼Œä¸æ•´ä½“è®¾è®¡é£æ ¼ä¸€è‡´
          
          ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
          - è·¨æµè§ˆå™¨æ»šåŠ¨æ¡éšè—å…¼å®¹æ€§
          - å®¹å™¨é«˜åº¦æ™ºèƒ½ç®¡ç†
          - å¸ƒå±€é‡æ„ï¼Œä»£ç æ›´ç®€æ´é«˜æ•ˆ
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          ### macOS ç”¨æˆ·
          - **Intel èŠ¯ç‰‡ Mac**: ä¸‹è½½ `MoliTodo-*.x64.dmg`
          - **Apple Silicon (M1/M2/M3) Mac**: ä¸‹è½½ `MoliTodo-*.arm64.dmg`
          
          ### Windows ç”¨æˆ·
          - ä¸‹è½½ `MoliTodo Setup *.exe`
          
          ğŸ’¡ **æç¤º**: å¦‚æœä¸ç¡®å®šä½ çš„ Mac èŠ¯ç‰‡ç±»å‹ï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¸Šè§’è‹¹æœèœå• > å…³äºæœ¬æœºæŸ¥çœ‹ã€‚
          
          ## ğŸ”„ å‡çº§è¯´æ˜
          
          - **æ— ç¼å‡çº§**: æœ¬æ¬¡æ›´æ–°ä¸»è¦ä¸ºç•Œé¢ä¼˜åŒ–ï¼Œæ— éœ€æ•°æ®è¿ç§»
          - **å³æ—¶ç”Ÿæ•ˆ**: å‡çº§åç«‹å³äº«å—æ›´æµç•…çš„å‘¨è§†å›¾ä½“éªŒ
          - **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹ç°æœ‰æ•°æ®å’Œè®¾ç½®
          
          ## ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md