name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} 🔍
          
          ## ✨ 计划视图时间筛选功能发布
          
          ### 🔍 智能时间筛选系统 (Time Filter System)
          - **多维度筛选**: 新增全部、过期、今天、明天、本周等多种时间维度筛选
          - **实时计数显示**: 各筛选选项实时显示对应的任务数量，便于快速了解任务分布
          - **过期任务警示**: 过期任务使用红色警示样式，提升视觉识别度和紧急性
          - **响应式设计**: 筛选按钮采用响应式布局，完美适配不同屏幕尺寸
          - **主题适配**: 完美支持明暗主题切换，保持视觉一致性
          
          ### 🛠️ TimeFilter 组件特性
          - **Vue 3 组合式 API**: 使用现代化的 Vue 3 Composition API 构建
          - **双向数据绑定**: 支持 v-model 模式，与父组件无缝数据同步
          - **事件驱动架构**: 基于事件的筛选变更机制，确保状态实时更新
          - **计算属性优化**: 使用计算属性优化任务计数性能，避免重复计算
          - **Font Awesome 图标**: 每个筛选选项配备直观的图标标识
          
          ## 🎯 用户价值提升
          
          ### 任务管理效率革命
          - **快速定位**: 通过时间筛选快速定位特定时间范围内的任务
          - **优先级识别**: 过期任务的醒目标识帮助用户识别紧急任务
          - **数据可视化**: 任务计数提供直观的任务分布数据
          - **工作流优化**: 支持按时间维度组织和管理工作流程
          
          ### 使用体验改善
          - **操作简便**: 一键切换不同时间维度的任务视图
          - **信息清晰**: 清晰的视觉层次和信息组织
          - **响应迅速**: 筛选操作即时响应，无延迟感
          - **习惯友好**: 符合用户习惯的筛选逻辑和界面设计
          
          ## 🔧 技术实现亮点
          
          ### 筛选维度详解
          - **全部任务**: 显示当前清单中的所有任务，不进行时间筛选
          - **过期任务**: 识别提醒时间早于当前时间的任务，红色警示显示
          - **今天任务**: 今天创建或今天需要提醒的任务，支持日常规划
          - **明天任务**: 明天需要处理或提醒的任务，帮助提前规划
          - **本周任务**: 本周内需要处理的所有任务，支持周期管理
          
          ### 性能优化策略
          - **计算属性缓存**: 利用 Vue 3 的计算属性缓存机制
          - **增量更新**: 只在任务数据变化时重新计算计数
          - **响应式监听**: 监听任务数据变化，自动更新计数
          - **内存管理**: 高效的内存使用和垃圾回收机制
          
          ## 🚀 应用场景
          
          ### 日常任务管理
          - **今日聚焦**: 使用"今天"筛选专注于当日任务
          - **应急处理**: 使用"过期"筛选快速识别紧急任务
          - **提前规划**: 使用"明天"筛选提前安排明日工作
          - **周度计划**: 使用"本周"筛选进行周期性规划
          
          ### 工作效率提升
          - **优先级管理**: 通过过期任务标识进行优先级管理
          - **时间分配**: 根据任务计数合理分配时间和精力
          - **进度跟踪**: 通过不同时间维度跟踪任务完成进度
          - **工作节奏**: 建立更好的工作节奏和时间管理习惯
          
          ## 🔄 升级说明
          
          ### 新功能使用
          1. **打开计划视图**: 在任务管理器中选择"计划中"分类
          2. **使用时间筛选**: 在顶部筛选栏中选择需要的时间维度
          3. **查看任务计数**: 观察各筛选选项的任务数量统计
          4. **快速切换**: 在不同时间维度间快速切换查看
          
          - **无缝升级**: 完全兼容现有配置和数据
          - **功能增强**: 在原有功能基础上增加新的筛选能力
          - **性能提升**: 优化的筛选算法提升整体性能
          - **向后兼容**: 保持所有现有功能和行为不变
          
          ## 📋 完整更新日志
          
          查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) 了解详细的更新内容。
          
          ---
          
          **Release Candidate 说明**: 这是一个发布候选版本，时间筛选功能已经稳定，欢迎用户测试并提供反馈。
          
          感谢使用 MoliTodo！智能时间筛选让任务管理变得更加高效和便捷。如有问题或建议，欢迎在 GitHub 上反馈。
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md