name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ğŸ‰
          
          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°äº®ç‚¹
          
          ### âœ¨ ä»»åŠ¡æé†’æ—¶é—´è”åŠ¨åŠŸèƒ½
          - **æ™ºèƒ½æ—¶é—´è”åŠ¨**: è®¾ç½®ä»»åŠ¡æ—¥æœŸæ—¶ï¼Œæé†’æ—¶é—´è‡ªåŠ¨åŒæ­¥åˆ°åŒä¸€å¤©
          - **æ—¶é—´ä¸€è‡´æ€§**: ç¡®ä¿ä»»åŠ¡æ—¥æœŸå’Œæé†’æ—¶é—´ä¿æŒé€»è¾‘ä¸€è‡´ï¼Œé¿å…è®¾ç½®é”™è¯¯
          - **ç”¨æˆ·å‹å¥½**: å‡å°‘æ‰‹åŠ¨è®¾ç½®æ­¥éª¤ï¼Œæé«˜ä»»åŠ¡åˆ›å»ºæ•ˆç‡
          
          ### ğŸŒ™ æ·±è‰²æ¨¡å¼å®Œå–„
          - **æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨å›¾æ ‡**: åŸç”Ÿå›¾æ ‡å®Œç¾æ”¯æŒæ·±è‰²æ¨¡å¼åˆ‡æ¢
          - **å¼¹å‡ºé€‰æ‹©å™¨ä¼˜åŒ–**: æ—¥å†å’Œæ—¶é—´é€‰æ‹©å™¨å¼¹çª—åœ¨æ·±è‰²æ¨¡å¼ä¸‹æ­£ç¡®æ˜¾ç¤º
          - **Tailwind CSS é›†æˆ**: ä½¿ç”¨ç°ä»£åŒ–çš„æ·±è‰²æ¨¡å¼è§£å†³æ–¹æ¡ˆ
          - **è·¨æµè§ˆå™¨å…¼å®¹**: ç¡®ä¿å„æµè§ˆå™¨ä¸‹çš„ä¸€è‡´ä½“éªŒ
          
          ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
          - TaskEdit.vue ç»„ä»¶ä¼˜åŒ–ï¼Œæå‡ä»»åŠ¡ç¼–è¾‘ä½“éªŒ
          - æ ·å¼ç³»ç»Ÿå®Œå–„ï¼Œç»Ÿä¸€ä½¿ç”¨ Tailwind CSS ç±»
          - å“åº”å¼è®¾è®¡æ”¹è¿›ï¼Œé€‚é…ä¸åŒå±å¹•å°ºå¯¸
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          ### macOS ç”¨æˆ·
          - **Intel èŠ¯ç‰‡ Mac**: ä¸‹è½½ `MoliTodo-*.x64.dmg`
          - **Apple Silicon (M1/M2/M3) Mac**: ä¸‹è½½ `MoliTodo-*.arm64.dmg`
          
          ### Windows ç”¨æˆ·
          - ä¸‹è½½ `MoliTodo Setup *.exe`
          
          ğŸ’¡ **æç¤º**: å¦‚æœä¸ç¡®å®šä½ çš„ Mac èŠ¯ç‰‡ç±»å‹ï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¸Šè§’è‹¹æœèœå• > å…³äºæœ¬æœºæŸ¥çœ‹ã€‚
          
          ## ğŸ”„ å‡çº§è¯´æ˜
          
          - **æ— ç¼å‡çº§**: æœ¬æ¬¡æ›´æ–°ä¸»è¦ä¸ºåŠŸèƒ½ä¼˜åŒ–ï¼Œæ— éœ€æ•°æ®è¿ç§»
          - **å³æ—¶ç”Ÿæ•ˆ**: å‡çº§åç«‹å³äº«å—æ›´æ™ºèƒ½çš„ä»»åŠ¡ç®¡ç†ä½“éªŒ
          - **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹ç°æœ‰æ•°æ®å’Œè®¾ç½®
          
          ## ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md