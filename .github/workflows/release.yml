name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} âœ¨
          
          ## ðŸŽ‰ æ­£å¼ç‰ˆæœ¬å‘å¸ƒ - AI æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿé‡ç£…ä¸Šçº¿
          
          MoliTodo v1.0.0 æ­£å¼ç‰ˆæœ¬éš†é‡å‘å¸ƒï¼è¿™æ˜¯ä¸€ä¸ªå…·æœ‰é‡Œç¨‹ç¢‘æ„ä¹‰çš„ç‰ˆæœ¬ï¼Œæ ‡å¿—ç€ MoliTodo ä»Žç®€å•çš„ä»»åŠ¡ç®¡ç†å·¥å…·è¿›åŒ–ä¸ºæ™ºèƒ½åŒ–çš„å·¥ä½œæ•ˆçŽ‡åŠ©æ‰‹ã€‚
          
          ### ðŸ¤– AI æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿ (AI Report Generation System)
          
          #### æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§
          - **ä¸€é”®ç”Ÿæˆå·¥ä½œæŠ¥å‘Š**: åŸºäºŽçŽ°æœ‰å¼ºå¤§çš„ AI åŸºç¡€è®¾æ–½ï¼Œæ–°å¢žæ™ºèƒ½æŠ¥å‘Šç”ŸæˆåŠŸèƒ½
          - **å¤šAIæä¾›å•†æ”¯æŒ**: åˆ©ç”¨ OpenAIã€Google Geminiã€Anthropic Claudeã€xAI Grok ç­‰é¡¶çº§ AI æœåŠ¡
          - **æ™ºèƒ½å†…å®¹åˆ†æž**: AI æ·±åº¦åˆ†æžä»»åŠ¡çŠ¶æ€ã€æ—¶é—´åˆ†å¸ƒã€å®Œæˆæƒ…å†µï¼Œç”Ÿæˆä¸“ä¸šçº§å·¥ä½œæŠ¥å‘Š
          - **è‡ªå®šä¹‰æŠ¥å‘Šæ¨¡æ¿**: æ”¯æŒä¸ªæ€§åŒ–çš„æ—¥æŠ¥å’Œå‘¨æŠ¥æ¨¡æ¿é…ç½®ï¼Œæ»¡è¶³ä¸åŒå·¥ä½œåœºæ™¯éœ€æ±‚
          - **Markdown æ ¼å¼è¾“å‡º**: ç”Ÿæˆç»“æž„åŒ–çš„ Markdown æ ¼å¼æŠ¥å‘Šï¼Œæ˜“äºŽåˆ†äº«å’Œå­˜æ¡£
          
          #### æ™ºèƒ½ç‰¹æ€§äº®ç‚¹
          - **æ—¶é—´ç­›é€‰é›†æˆ**: AI æŠ¥å‘ŠæŒ‰é’®æ— ç¼é›†æˆåˆ°æ—¶é—´ç­›é€‰ç»„ä»¶ï¼ŒåŸºäºŽå½“å‰ç­›é€‰ä¸Šä¸‹æ–‡ç”Ÿæˆç›¸åº”æŠ¥å‘Š
          - **æ™ºèƒ½æŠ¥å‘Šç±»åž‹åˆ¤æ–­**: æ ¹æ®ç­›é€‰æ¡ä»¶è‡ªåŠ¨åˆ¤æ–­ç”Ÿæˆæ—¥æŠ¥è¿˜æ˜¯å‘¨æŠ¥
          - **ä»»åŠ¡çŠ¶æ€ç²¾å‡†è¯†åˆ«**: åŸºäºŽä»»åŠ¡çš„ status å­—æ®µç²¾ç¡®åˆ¤æ–­ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
          - **ä¸€é”®å¤åˆ¶åŠŸèƒ½**: ç”Ÿæˆçš„æŠ¥å‘Šæ”¯æŒä¸€é”®å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œä¾¿äºŽå³æ—¶ä½¿ç”¨
          - **åŠ è½½çŠ¶æ€åé¦ˆ**: å®Œå–„çš„åŠ è½½åŠ¨ç”»å’ŒçŠ¶æ€æç¤ºï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒæµç•…
          
          ### ðŸŽ¯ 1.0.0 é‡Œç¨‹ç¢‘æ„ä¹‰
          
          #### åŠŸèƒ½ç”Ÿæ€ç³»ç»Ÿå®Œå–„
          - **AI ç”Ÿæ€é—­çŽ¯**: ä»Žä»»åŠ¡åˆ›å»ºåˆ°æŠ¥å‘Šç”Ÿæˆï¼Œå½¢æˆå®Œæ•´çš„ AI é©±åŠ¨å·¥ä½œæµ
          - **ä¼ä¸šçº§åº”ç”¨**: æŠ¥å‘Šç”ŸæˆåŠŸèƒ½ä½¿åº”ç”¨å…·å¤‡ä¼ä¸šçº§å·¥ä½œåœºæ™¯é€‚ç”¨æ€§
          - **æ™ºèƒ½å·¥ä½œåŠ©æ‰‹**: ä»Žç®€å•ä»»åŠ¡ç®¡ç†è¿›åŒ–ä¸ºæ™ºèƒ½åŒ–å·¥ä½œæ•ˆçŽ‡åŠ©æ‰‹
          - **è¡Œä¸šé¢†å…ˆåœ°ä½**: åœ¨ä»»åŠ¡ç®¡ç†åº”ç”¨ä¸­çŽ‡å…ˆå®žçŽ°æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ
          
          #### æŠ€æœ¯æž¶æž„æˆç†Ÿåº¦
          - **å¾®æœåŠ¡åŒ–å®žçŽ°**: æŠ¥å‘ŠæœåŠ¡çš„ç‹¬ç«‹åŒ–ä½“çŽ°äº†æž¶æž„çš„æˆç†Ÿ
          - **æ‰©å±•æ€§åŸºç¡€**: ä¸ºæœªæ¥æ›´å¤š AI åŠŸèƒ½å¥ å®šäº†åšå®žåŸºç¡€
          - **ç¨³å®šæ€§ä¿è¯**: ç»è¿‡å¤šä¸ªç‰ˆæœ¬è¿­ä»£ï¼Œæž¶æž„ç¨³å®šå¯é 
          - **æ€§èƒ½ä¼˜åŒ–**: è¾¾åˆ°ä¼ä¸šçº§åº”ç”¨çš„æ€§èƒ½è¦æ±‚
          
          ## ðŸ“š ä½¿ç”¨æŒ‡å—
          
          ### å¿«é€Ÿå¼€å§‹
          1. **é…ç½® AI æœåŠ¡**: åœ¨è®¾ç½®é¡µé¢é…ç½®è‡³å°‘ä¸€ä¸ª AI æä¾›å•†
          2. **è‡ªå®šä¹‰æ¨¡æ¿**: ï¼ˆå¯é€‰ï¼‰åœ¨ AI è®¾ç½®ä¸­è‡ªå®šä¹‰æŠ¥å‘Šæ¨¡æ¿
          3. **ç­›é€‰ä»»åŠ¡**: ä½¿ç”¨æ—¶é—´ç­›é€‰é€‰æ‹©è¦åˆ†æžçš„ä»»åŠ¡èŒƒå›´
          4. **ç”ŸæˆæŠ¥å‘Š**: ç‚¹å‡» AI æŠ¥å‘ŠæŒ‰é’®ï¼Œé€‰æ‹© AI æ¨¡åž‹å¹¶ç”Ÿæˆ
          5. **æŸ¥çœ‹å’Œå¤åˆ¶**: åœ¨å¼¹çª—ä¸­æŸ¥çœ‹æŠ¥å‘Šå†…å®¹ï¼Œä¸€é”®å¤åˆ¶ä½¿ç”¨
          
          ### æ¨¡æ¿å®šåˆ¶
          - **å ä½ç¬¦è¯­æ³•**: ä½¿ç”¨ `{{å˜é‡å}}` è¯­æ³•å®šä¹‰åŠ¨æ€å†…å®¹ä½ç½®
          - **æ”¯æŒå˜é‡**: `{{project_name}}`ã€`{{report_period}}`ã€`{{summary}}`ã€`{{completed_tasks}}` ç­‰
          - **Markdown æ ¼å¼**: æ¨¡æ¿æ”¯æŒå®Œæ•´çš„ Markdown è¯­æ³•æ ¼å¼åŒ–
          - **é¢„è§ˆåŠŸèƒ½**: é…ç½®è¿‡ç¨‹ä¸­å®žæ—¶é¢„è§ˆæ¨¡æ¿æ•ˆæžœ
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          ### å…¼å®¹æ€§ä¿è¯
          - **å®Œå…¨å‘åŽå…¼å®¹**: çŽ°æœ‰æ‰€æœ‰æ•°æ®å’Œé…ç½®å®Œå…¨ä¿ç•™
          - **AI é…ç½®å¤ç”¨**: åˆ©ç”¨çŽ°æœ‰ AI é…ç½®ï¼Œæ— éœ€é‡æ–°è®¾ç½®
          - **åŠŸèƒ½å¢žå¼º**: åœ¨çŽ°æœ‰åŠŸèƒ½åŸºç¡€ä¸Šæ–°å¢žæŠ¥å‘ŠåŠŸèƒ½ï¼Œä¸å½±å“åŽŸæœ‰å·¥ä½œæµç¨‹
          - **å³æ—¶å¯ç”¨**: æœ‰ AI é…ç½®çš„ç”¨æˆ·å‡çº§åŽç«‹å³å¯ä½¿ç”¨æ–°åŠŸèƒ½
          
          ### æ€§èƒ½æå‡
          - **å“åº”ä¼˜åŒ–**: æ”¹è¿› AI è°ƒç”¨çš„å“åº”æ—¶é—´å’Œç”¨æˆ·åé¦ˆ
          - **å†…å­˜æ•ˆçŽ‡**: ä¼˜åŒ–æŠ¥å‘Šç”Ÿæˆè¿‡ç¨‹çš„å†…å­˜ä½¿ç”¨
          - **å¹¶å‘å¤„ç†**: ä¼˜åŒ–å¤šä¸ªæŠ¥å‘Šç”Ÿæˆè¯·æ±‚çš„å¹¶å‘å¤„ç†
          
          ## ðŸš€ æœªæ¥å±•æœ›
          
          v1.0.0 çš„å‘å¸ƒæ ‡å¿—ç€ MoliTodo è¿›å…¥äº†æ–°çš„å‘å±•é˜¶æ®µã€‚åŸºäºŽè¿™ä¸ªå¼ºå¤§çš„ AI æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿï¼Œæˆ‘ä»¬å°†ç»§ç»­æŽ¢ç´¢æ›´å¤šæ™ºèƒ½åŒ–åŠŸèƒ½ï¼š
          
          - **è¯­éŸ³æŠ¥å‘Šç”Ÿæˆ**: é€šè¿‡è¯­éŸ³æŒ‡ä»¤å¿«é€Ÿç”ŸæˆæŠ¥å‘Š
          - **å›¢é˜Ÿåä½œæŠ¥å‘Š**: æ”¯æŒå›¢é˜Ÿçº§åˆ«çš„åä½œæŠ¥å‘Šç”Ÿæˆ
          - **æ•°æ®å¯è§†åŒ–**: å°†æŠ¥å‘Šæ•°æ®è½¬åŒ–ä¸ºå›¾è¡¨å’Œå¯è§†åŒ–å†…å®¹
          - **é¢„æµ‹æ€§åˆ†æž**: åŸºäºŽåŽ†å²æ•°æ®çš„å·¥ä½œè¶‹åŠ¿é¢„æµ‹
          
          ## ðŸ™ è‡´è°¢
          
          æ„Ÿè°¢æ‰€æœ‰ç”¨æˆ·çš„æ”¯æŒå’Œåé¦ˆï¼Œç‰¹åˆ«æ˜¯é‚£äº›ç§¯æžä½¿ç”¨ AI åŠŸèƒ½å¹¶æä¾›æ”¹è¿›å»ºè®®çš„ç”¨æˆ·ã€‚æ­£æ˜¯å¤§å®¶çš„å‚ä¸Žå’Œå»ºè®®ï¼Œä½¿å¾— MoliTodo èƒ½å¤Ÿä¸æ–­è¿›åŒ–ï¼Œæˆä¸ºä»Šå¤©è¿™æ ·å¼ºå¤§çš„æ™ºèƒ½å·¥ä½œåŠ©æ‰‹ã€‚
          
          ---
          
          **ç«‹å³ä½“éªŒ**: [ä¸‹è½½ MoliTodo v1.0.0](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }})  
          **åŠŸèƒ½æ–‡æ¡£**: [AI æŠ¥å‘Šç”Ÿæˆä½¿ç”¨æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/docs/releases/v1.0.0.md)  
          **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/${{ github.repository }}/issues)  
          **ç¤¾åŒºè®¨è®º**: [å¼€å‘è€…è®ºå›](https://github.com/${{ github.repository }}/discussions)
          
          **MoliTodo v1.0.0 - è®©æ™ºèƒ½æˆä¸ºå·¥ä½œæ•ˆçŽ‡çš„æ–°æ ‡å‡†ï¼**
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md