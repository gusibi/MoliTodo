name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ðŸš€
          
          ## ðŸŽ‰ é‡å¤§åŠŸèƒ½æ›´æ–°
          
          ### ðŸ¤– AI æ™ºèƒ½ä»»åŠ¡ç”Ÿæˆç³»ç»Ÿ
          - **å¤š AI æä¾›å•†æ”¯æŒ**: é›†æˆ OpenAIã€Google Geminiã€Anthropic Claudeã€xAI Grok å››å¤§ä¸»æµ AI æä¾›å•†
          - **è‡ªå®šä¹‰ AI é…ç½®**: æ”¯æŒæ·»åŠ è‡ªå®šä¹‰ AI æä¾›å•†ï¼Œæ»¡è¶³ä¼ä¸šå’Œä¸ªäººå®šåˆ¶éœ€æ±‚
          - **æ™ºèƒ½ä»»åŠ¡è§£æž**: AI å¯ä»¥å°†è‡ªç„¶è¯­è¨€æè¿°è½¬æ¢ä¸ºç»“æž„åŒ–çš„ä»»åŠ¡åˆ—è¡¨
          - **æ‰¹é‡ä»»åŠ¡ç”Ÿæˆ**: ä¸€æ¬¡è¾“å…¥å¯ç”Ÿæˆå¤šä¸ªç›¸å…³ä»»åŠ¡ï¼Œæé«˜å·¥ä½œæ•ˆçŽ‡
          - **ä»»åŠ¡é¢„è§ˆç¼–è¾‘**: ç”Ÿæˆçš„ä»»åŠ¡æ”¯æŒé¢„è§ˆå’Œç¼–è¾‘ï¼Œç¡®ä¿å‡†ç¡®æ€§åŽå†æ‰¹é‡åˆ›å»º
          
          ### âš™ï¸ AI é…ç½®ç®¡ç†ç•Œé¢
          - **è®¾ç½®é¡µé¢é›†æˆ**: åœ¨è®¾ç½®é¡µé¢æ–°å¢ž AI é…ç½®åˆ†ç±»ï¼Œæä¾›å®Œæ•´çš„ AI åŠŸèƒ½ç®¡ç†
          - **æä¾›å•†é€‰æ‹©**: ç›´è§‚çš„ AI æä¾›å•†é€‰æ‹©ç•Œé¢ï¼Œæ”¯æŒå®žæ—¶é…ç½®çŠ¶æ€æ˜¾ç¤º
          - **è¿žæŽ¥æµ‹è¯•**: å†…ç½® AI è¿žæŽ¥æµ‹è¯•åŠŸèƒ½ï¼Œç¡®ä¿é…ç½®æ­£ç¡®æ€§
          - **åŠŸèƒ½å¼€å…³**: æ”¯æŒç‹¬ç«‹æŽ§åˆ¶å„é¡¹ AI åŠŸèƒ½çš„å¯ç”¨çŠ¶æ€
          - **å®‰å…¨å­˜å‚¨**: API å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯å®‰å…¨å­˜å‚¨ï¼Œæ”¯æŒå¯†ç è¾“å…¥éšè—
          
          ### ðŸ’¡ æ™ºèƒ½ä»»åŠ¡è¾“å…¥ä½“éªŒ
          - **AI æ¨¡å¼åˆ‡æ¢**: ä»»åŠ¡è¾“å…¥æ¡†é›†æˆ AI å¼€å…³ï¼Œå¯éšæ—¶å¯ç”¨æˆ–ç¦ç”¨ AI åŠŸèƒ½
          - **å®žæ—¶æ¨¡åž‹é€‰æ‹©**: æ”¯æŒåœ¨ä»»åŠ¡åˆ›å»ºæ—¶åŠ¨æ€é€‰æ‹© AI æ¨¡åž‹
          - **ç”Ÿæˆè¿›åº¦åé¦ˆ**: AI ä»»åŠ¡ç”Ÿæˆè¿‡ç¨‹æä¾›å®žæ—¶è¿›åº¦æç¤ºå’ŒåŠ è½½çŠ¶æ€
          - **é”™è¯¯é™çº§**: AI ç”Ÿæˆå¤±è´¥æ—¶è‡ªåŠ¨å›žé€€åˆ°æ™®é€šä»»åŠ¡åˆ›å»ºæ¨¡å¼
          
          
          ## ðŸ› ï¸ æŠ€æœ¯æ”¹è¿›
          
          - **AI æœåŠ¡æž¶æž„**: æ–°å¢žç»Ÿä¸€çš„ AI æœåŠ¡å±‚ï¼Œæ”¯æŒå¤šæä¾›å•†ç®¡ç†
          - **ä¾èµ–åº“é›†æˆ**: å¼•å…¥ @ai-sdk ç³»åˆ—åº“ï¼Œæ”¯æŒä¸»æµ AI æä¾›å•†
          - **å®‰å…¨æœºåˆ¶**: æ•æ„Ÿé…ç½®ä¿¡æ¯çš„å®‰å…¨ä¼ è¾“å’Œå­˜å‚¨æœºåˆ¶
          - **æ€§èƒ½ä¼˜åŒ–**: AI è¯·æ±‚çš„é˜²æŠ–å’Œç¼“å­˜æœºåˆ¶
          - **çŠ¶æ€ç®¡ç†**: æ‰©å±• taskStore æ”¯æŒ AI ç›¸å…³çŠ¶æ€ç®¡ç†
          
          ## ðŸ“‹ ä½¿ç”¨è¯´æ˜Ž
          
          ### é…ç½® AI åŠŸèƒ½
          1. è¿›å…¥è®¾ç½®é¡µé¢çš„"AI é…ç½®"åˆ†ç±»
          2. é€‰æ‹©åˆé€‚çš„ AI æä¾›å•†ï¼ˆOpenAIã€Googleã€Anthropicã€xAI æˆ–è‡ªå®šä¹‰ï¼‰
          3. è¾“å…¥ç›¸åº”çš„ API Key å’Œé…ç½®ä¿¡æ¯
          4. ç‚¹å‡»"æµ‹è¯•è¿žæŽ¥"éªŒè¯é…ç½®æ­£ç¡®æ€§
          5. å¯ç”¨æ‰€éœ€çš„ AI åŠŸèƒ½é€‰é¡¹
          
          ### ä½¿ç”¨ AI ç”Ÿæˆä»»åŠ¡
          1. åœ¨ä»»åŠ¡è¾“å…¥æ¡†ä¸­ç‚¹å‡» AI å›¾æ ‡å¯ç”¨ AI æ¨¡å¼
          2. é€‰æ‹©è¦ä½¿ç”¨çš„ AI æ¨¡åž‹
          3. è¾“å…¥è‡ªç„¶è¯­è¨€æè¿°çš„ä»»åŠ¡éœ€æ±‚
          4. æŒ‰ Enter é”®è§¦å‘ AI ç”Ÿæˆ
          5. åœ¨é¢„è§ˆå¼¹çª—ä¸­ç¼–è¾‘å’Œç¡®è®¤ç”Ÿæˆçš„ä»»åŠ¡
          6. ç‚¹å‡»"åˆ›å»ºæ‰€æœ‰ä»»åŠ¡"å®Œæˆæ‰¹é‡æ·»åŠ 
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          - **æ•°æ®å…¼å®¹**: å®Œå…¨å‘åŽå…¼å®¹ï¼ŒçŽ°æœ‰æ•°æ®è‡ªåŠ¨è¿ç§»
          - **AI åŠŸèƒ½å¯é€‰**: AI åŠŸèƒ½ä¸ºå¯é€‰ç‰¹æ€§ï¼Œä¸å½±å“çŽ°æœ‰å·¥ä½œæµç¨‹
          - **æ¸è¿›å¼å¯ç”¨**: ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ€§å¯ç”¨ä¸åŒçš„ AI åŠŸèƒ½
          - **é…ç½®ç‹¬ç«‹**: AI é…ç½®ç‹¬ç«‹å­˜å‚¨ï¼Œä¸å½±å“å…¶ä»–åº”ç”¨è®¾ç½®
          
          ## ðŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼AI æ™ºèƒ½åŠŸèƒ½è®©ä»»åŠ¡ç®¡ç†æ›´åŠ é«˜æ•ˆä¾¿æ·ã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md