name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ğŸ‰
          
          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°äº®ç‚¹
          
          ### âœ¨ æ‚¬æµ®ä»»åŠ¡å¡ç‰‡è§†è§‰ä¼˜åŒ–
          - **é¢œè‰²æ­é…ä¼˜åŒ–**: ä¼˜åŒ–æ‚¬æµ®ä»»åŠ¡å¡ç‰‡çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡†é¢œè‰²ï¼Œæé«˜å†…å®¹å¯è¯»æ€§å’Œè§†è§‰å±‚æ¬¡
          - **ç•™ç™½å¹³è¡¡è°ƒæ•´**: ç»Ÿä¸€æ‚¬æµ®ä»»åŠ¡å¡ç‰‡çš„ä¸Šä¸‹å·¦å³ç•™ç™½ï¼Œå®ç°è§†è§‰å¹³è¡¡
          - **å¡ç‰‡å°ºå¯¸æ‰©å¤§**: å°†æ‚¬æµ®ä»»åŠ¡çª—å£å°ºå¯¸ä» 360x120px æ‰©å¤§åˆ° 420x140pxï¼Œæä¾›æ›´å¤§çš„å†…å®¹ç©ºé—´
          - **æ ‡ç­¾å­—ä½“ä¼˜åŒ–**: ä»»åŠ¡æ ‡ç­¾å­—ä½“å¤§å°è°ƒæ•´ï¼Œä½¿æ ‡ç­¾æ›´åŠ ç²¾è‡´
          - **æ‹–æ‹½åŠŸèƒ½ä¿®å¤**: ä¿®å¤æ‚¬æµ®ä»»åŠ¡å¡ç‰‡çš„æ‹–æ‹½åŠŸèƒ½ï¼Œç¡®ä¿çª—å£ç§»åŠ¨æ­£å¸¸å·¥ä½œ
          
          ### ğŸ¯ Todayåˆ†ç±»é€»è¾‘ç»Ÿä¸€
          - **é€»è¾‘ä¸€è‡´æ€§**: ç»Ÿä¸€TaskPanel.vueå’ŒSidebarNav.vueä¸­todayåˆ†ç±»çš„åˆ¤æ–­é€»è¾‘
          - **æ™ºèƒ½ä»»åŠ¡ç­›é€‰**: todayåˆ†ç±»ç°åœ¨åŒ…å«ä»Šå¤©åˆ›å»ºçš„ä»»åŠ¡ã€ä»Šå¤©æé†’åˆ°æœŸçš„ä»»åŠ¡ä»¥åŠæ­£åœ¨è¿›è¡Œä¸­çš„ä»»åŠ¡
          - **æ•°æ®åŒæ­¥**: ç¡®ä¿ä»»åŠ¡é¢æ¿æ˜¾ç¤ºçš„ä»»åŠ¡æ•°é‡ä¸ä¾§è¾¹æ è®¡æ•°ä¿æŒä¸€è‡´
          
          ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
          - Tailwind CSS æ‰©å±•ï¼Œæ·»åŠ è‡ªå®šä¹‰å­—ä½“å¤§å°å®šä¹‰
          - ä¼˜åŒ–æ‚¬æµ®ä»»åŠ¡ç›¸å…³çš„CSSç±»ï¼Œæå‡æ ·å¼ç»´æŠ¤æ€§
          - æ”¹è¿›æ‚¬æµ®ä»»åŠ¡å¡ç‰‡çš„è‡ªé€‚åº”å®½åº¦è®¾è®¡
          - ä¼˜åŒ–çª—å£ç®¡ç†å’Œå®¹å™¨å¸ƒå±€é€»è¾‘
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          ### macOS ç”¨æˆ·
          - **Intel èŠ¯ç‰‡ Mac**: ä¸‹è½½ `MoliTodo-*.x64.dmg`
          - **Apple Silicon (M1/M2/M3) Mac**: ä¸‹è½½ `MoliTodo-*.arm64.dmg`
          
          ### Windows ç”¨æˆ·
          - ä¸‹è½½ `MoliTodo Setup *.exe`
          
          ğŸ’¡ **æç¤º**: å¦‚æœä¸ç¡®å®šä½ çš„ Mac èŠ¯ç‰‡ç±»å‹ï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¸Šè§’è‹¹æœèœå• > å…³äºæœ¬æœºæŸ¥çœ‹ã€‚
          
          ## ğŸ”„ å‡çº§è¯´æ˜
          
          - **æ— ç¼å‡çº§**: æœ¬æ¬¡æ›´æ–°ä¸»è¦ä¸ºUIä¼˜åŒ–å’Œé€»è¾‘ç»Ÿä¸€ï¼Œæ— éœ€æ•°æ®è¿ç§»
          - **å³æ—¶ç”Ÿæ•ˆ**: å‡çº§åç«‹å³äº«å—æ›´ä¼˜é›…çš„æ‚¬æµ®ä»»åŠ¡ä½“éªŒ
          - **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹ç°æœ‰æ•°æ®å’Œè®¾ç½®
          
          ## ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md