name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ðŸŽ¨
          
          ## âœ¨ åº”ç”¨ä¸ªæ€§åŒ–æ–°åŠŸèƒ½
          
          ### ðŸŽ¨ åº”ç”¨å›¾æ ‡ä¸ªæ€§åŒ–ç³»ç»Ÿ (App Icon Customization System)
          - **å¤šæ ·åŒ–å›¾æ ‡é€‰æ‹©**: æ–°å¢ž7ç§ä¸åŒé£Žæ ¼çš„åº”ç”¨å›¾æ ‡ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚
          - **å®žæ—¶åˆ‡æ¢åŠŸèƒ½**: åœ¨è®¾ç½®é¡µé¢é€‰æ‹©å›¾æ ‡åŽç«‹å³åº”ç”¨ï¼Œæ— éœ€é‡å¯åº”ç”¨
          - **å¯è§†åŒ–é€‰æ‹©ç•Œé¢**: æ–°å¢ž"åº”ç”¨å›¾æ ‡"è®¾ç½®åˆ†ç±»ï¼Œæä¾›ç›´è§‚çš„å›¾æ ‡é¢„è§ˆå’Œé€‰æ‹©
          - **é£Žæ ¼ä¸°å¯Œå¤šæ ·**: åŒ…å«é»˜è®¤ã€ç»å…¸ã€çŽ°ä»£ã€ç®€çº¦ã€å½©è‰²ã€ç´«è‰²æ—¶é—´ã€æžç®€ä¸»é¢˜ç­‰é£Žæ ¼
          - **é…ç½®æŒä¹…åŒ–**: å›¾æ ‡é€‰æ‹©è‡ªåŠ¨ä¿å­˜ï¼Œé‡å¯åŽä¿æŒç”¨æˆ·é€‰æ‹©
          
          ### ðŸ› ï¸ æŠ€æœ¯å®žçŽ°äº®ç‚¹
          - **åŠ¨æ€å›¾æ ‡ç³»ç»Ÿ**: åˆ©ç”¨ Electron API å®žçŽ°è¿è¡Œæ—¶å›¾æ ‡åŠ¨æ€æ›´æ–°
          - **LogoSelectorç»„ä»¶**: å…¨æ–°çš„å›¾æ ‡é€‰æ‹©å™¨ç»„ä»¶ï¼Œæ”¯æŒç½‘æ ¼å¸ƒå±€å’ŒçŠ¶æ€æŒ‡ç¤º
          - **èµ„æºç®¡ç†ä¼˜åŒ–**: ä¼˜åŒ–å›¾æ ‡èµ„æºçš„åŠ è½½å’Œç¼“å­˜æœºåˆ¶
          - **é”™è¯¯å¤„ç†å®Œå–„**: å®Œå–„çš„å›¾æ ‡åˆ‡æ¢é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
          
          ## ðŸŽ¯ ç”¨æˆ·ä»·å€¼æå‡
          
          ### ä¸ªæ€§åŒ–ä½“éªŒ
          - **é£Žæ ¼é€‰æ‹©è‡ªç”±**: ç”¨æˆ·å¯æ ¹æ®ä¸ªäººå–œå¥½é€‰æ‹©æœ€ç¬¦åˆå®¡ç¾Žçš„å›¾æ ‡é£Žæ ¼
          - **åœºæ™¯é€‚é…**: ä¸åŒå·¥ä½œå’Œç”Ÿæ´»åœºæ™¯å¯é€‰æ‹©ç›¸åº”é£Žæ ¼çš„å›¾æ ‡
          - **å³æ—¶ç”Ÿæ•ˆ**: é€‰æ‹©æ–°å›¾æ ‡åŽç«‹å³åº”ç”¨ï¼Œæ— éœ€ç­‰å¾…é‡å¯
          - **å“ç‰Œè¯†åˆ«**: åœ¨ä¼—å¤šåº”ç”¨ä¸­å¿«é€Ÿè¯†åˆ«å’Œå®šä½ MoliTodo
          
          ### ä½¿ç”¨åœºæ™¯æŽ¨è
          - **å·¥ä½œçŽ¯å¢ƒ**: é€‰æ‹©ç®€çº¦ã€çŽ°ä»£é£Žæ ¼çš„å›¾æ ‡ï¼Œä¿æŒä¸“ä¸šå½¢è±¡
          - **ä¸ªäººä½¿ç”¨**: é€‰æ‹©å½©è‰²ã€æœ‰è¶£çš„å›¾æ ‡ï¼Œå¢žåŠ ä½¿ç”¨ä¹è¶£
          - **ä¸»é¢˜æ­é…**: æ ¹æ®ç³»ç»Ÿä¸»é¢˜é€‰æ‹©ç›¸åº”é£Žæ ¼çš„å›¾æ ‡
          - **å¤šç”¨æˆ·çŽ¯å¢ƒ**: ä¸åŒç”¨æˆ·å¯è®¾ç½®ä¸åŒå›¾æ ‡ä»¥åŒºåˆ†èº«ä»½
          
          ## ðŸ”§ å›¾æ ‡é£Žæ ¼è¯¦è§£
          
          ### å¯é€‰å›¾æ ‡é£Žæ ¼
          - **é»˜è®¤å›¾æ ‡**: ç»å…¸æ—¶é’Ÿè®¾è®¡ï¼Œä½“çŽ°æ—¶é—´ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
          - **ç»å…¸ç‰ˆæœ¬**: ä¼ ç»Ÿå¾…åŠžæ¸…å•å›¾æ ‡ï¼Œæ²‰ç¨³å¯é 
          - **çŽ°ä»£ç‰ˆæœ¬**: èžå…¥çŽ°ä»£è®¾è®¡å…ƒç´ ï¼Œæ—¶å°šç®€çº¦
          - **ç®€çº¦é£Žæ ¼**: æžç®€ä¸»ä¹‰è®¾è®¡ï¼ŒåŽ»é™¤å¤šä½™å…ƒç´ 
          - **å½©è‰²ç‰ˆæœ¬**: ä¸°å¯Œè‰²å½©æ­é…ï¼Œæ´»æ³¼ç”ŸåŠ¨
          - **ç´«è‰²æ—¶é—´**: ç´«è‰²ä¸»è°ƒçš„æ—¶é—´ä¸»é¢˜ï¼Œä¼˜é›…ç¥žç§˜
          - **æžç®€ä¸»é¢˜**: æœ€æžç®€è®¾è®¡ï¼Œé«˜åº¦æŠ½è±¡ä¸“ä¸š
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          ### æ–°åŠŸèƒ½ä½¿ç”¨
          1. **æ‰“å¼€è®¾ç½®**: ç‚¹å‡»åº”ç”¨å³ä¸Šè§’çš„è®¾ç½®å›¾æ ‡
          2. **é€‰æ‹©å›¾æ ‡**: åœ¨è®¾ç½®é¡µé¢æ‰¾åˆ°"åº”ç”¨å›¾æ ‡"åˆ†ç±»
          3. **é¢„è§ˆé€‰æ‹©**: æµè§ˆæ‰€æœ‰å¯ç”¨å›¾æ ‡å¹¶æŸ¥çœ‹é¢„è§ˆæ•ˆæžœ
          4. **ç¡®è®¤åº”ç”¨**: ç‚¹å‡»æƒ³è¦çš„å›¾æ ‡å³å¯ç«‹å³åº”ç”¨
          
          - **æ— ç¼å‡çº§**: å®Œå…¨å…¼å®¹çŽ°æœ‰é…ç½®å’Œæ•°æ®
          - **ç«‹å³ç”Ÿæ•ˆ**: å‡çº§åŽå›¾æ ‡ä¸ªæ€§åŒ–åŠŸèƒ½ç«‹å³å¯ç”¨
          - **æ€§èƒ½ä¼˜åŒ–**: å›¾æ ‡åˆ‡æ¢å¯¹åº”ç”¨æ€§èƒ½å½±å“å¾®ä¹Žå…¶å¾®
          - **å‘åŽå…¼å®¹**: ä¿æŒæ‰€æœ‰çŽ°æœ‰åŠŸèƒ½å’Œé…ç½®ä¸å˜
          
          ## ðŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          **Release Candidate è¯´æ˜Ž**: è¿™æ˜¯ä¸€ä¸ªå‘å¸ƒå€™é€‰ç‰ˆæœ¬ï¼Œä¸»è¦åŠŸèƒ½å·²ç»ç¨³å®šï¼Œæ¬¢è¿Žç”¨æˆ·æµ‹è¯•å¹¶æä¾›åé¦ˆã€‚
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼ä¸ªæ€§åŒ–çš„åº”ç”¨å›¾æ ‡è®©æ¯ä¸ªç”¨æˆ·éƒ½èƒ½æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„ä½“éªŒã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md