name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} 🎨
          
          ## ✨ 应用个性化新功能
          
          ### 🎨 应用图标个性化系统 (App Icon Customization System)
          - **多样化图标选择**: 新增7种不同风格的应用图标，满足个性化需求
          - **实时切换功能**: 在设置页面选择图标后立即应用，无需重启应用
          - **可视化选择界面**: 新增"应用图标"设置分类，提供直观的图标预览和选择
          - **风格丰富多样**: 包含默认、经典、现代、简约、彩色、紫色时间、极简主题等风格
          - **配置持久化**: 图标选择自动保存，重启后保持用户选择
          
          ### 🛠️ 技术实现亮点
          - **动态图标系统**: 利用 Electron API 实现运行时图标动态更新
          - **LogoSelector组件**: 全新的图标选择器组件，支持网格布局和状态指示
          - **资源管理优化**: 优化图标资源的加载和缓存机制
          - **错误处理完善**: 完善的图标切换错误处理和降级机制
          
          ## 🎯 用户价值提升
          
          ### 个性化体验
          - **风格选择自由**: 用户可根据个人喜好选择最符合审美的图标风格
          - **场景适配**: 不同工作和生活场景可选择相应风格的图标
          - **即时生效**: 选择新图标后立即应用，无需等待重启
          - **品牌识别**: 在众多应用中快速识别和定位 MoliTodo
          
          ### 使用场景推荐
          - **工作环境**: 选择简约、现代风格的图标，保持专业形象
          - **个人使用**: 选择彩色、有趣的图标，增加使用乐趣
          - **主题搭配**: 根据系统主题选择相应风格的图标
          - **多用户环境**: 不同用户可设置不同图标以区分身份
          
          ## 🔧 图标风格详解
          
          ### 可选图标风格
          - **默认图标**: 经典时钟设计，体现时间管理核心功能
          - **经典版本**: 传统待办清单图标，沉稳可靠
          - **现代版本**: 融入现代设计元素，时尚简约
          - **简约风格**: 极简主义设计，去除多余元素
          - **彩色版本**: 丰富色彩搭配，活泼生动
          - **紫色时间**: 紫色主调的时间主题，优雅神秘
          - **极简主题**: 最极简设计，高度抽象专业
          
          ## 🔄 升级说明
          
          ### 新功能使用
          1. **打开设置**: 点击应用右上角的设置图标
          2. **选择图标**: 在设置页面找到"应用图标"分类
          3. **预览选择**: 浏览所有可用图标并查看预览效果
          4. **确认应用**: 点击想要的图标即可立即应用
          
          - **无缝升级**: 完全兼容现有配置和数据
          - **立即生效**: 升级后图标个性化功能立即可用
          - **性能优化**: 图标切换对应用性能影响微乎其微
          - **向后兼容**: 保持所有现有功能和配置不变
          
          ## 📋 完整更新日志
          
          查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) 了解详细的更新内容。
          
          ---
          
          **Release Candidate 说明**: 这是一个发布候选版本，主要功能已经稳定，欢迎用户测试并提供反馈。
          
          感谢使用 MoliTodo！个性化的应用图标让每个用户都能拥有独一无二的体验。如有问题或建议，欢迎在 GitHub 上反馈。
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md