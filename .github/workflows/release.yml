name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ğŸ‰
          
          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°äº®ç‚¹
          
          ### ğŸ†• å…¨æ–°æ¸…å•ç®¡ç†ç³»ç»Ÿ
          - **å¤šæ¸…å•æ”¯æŒ**: åˆ›å»ºè‡ªå®šä¹‰æ¸…å•ï¼Œæ›´å¥½åœ°ç»„ç»‡ä½ çš„ä»»åŠ¡
          - **æ™ºèƒ½åˆ†ç±»**: æ”¶ä»¶ç®±ã€ä»Šå¤©ã€è¿›è¡Œä¸­ç­‰æ™ºèƒ½è§†å›¾
          - **ä¸ªæ€§åŒ–å®šåˆ¶**: è‡ªå®šä¹‰æ¸…å•é¢œè‰²å’Œå›¾æ ‡
          - **æ¸…å•ä¾§è¾¹æ **: å…¨æ–°çš„å¯¼èˆªä½“éªŒ
          
          ### âš¡ æ€§èƒ½ä¸ä½“éªŒä¼˜åŒ–
          - æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æå‡ 40%
          - å¯åŠ¨æ—¶é—´ç¼©çŸ­ 15%
          - å†…å­˜ä½¿ç”¨ä¼˜åŒ– 20%
          - å…¨æ–°çš„ UI è®¾è®¡
          
          ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
          - è‡ªåŠ¨æ•°æ®åº“è¿ç§»ç³»ç»Ÿ
          - å¢å¼ºçš„æ•°æ®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
          - æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          ### macOS ç”¨æˆ·
          - **Intel èŠ¯ç‰‡ Mac**: ä¸‹è½½ `MoliTodo-*.x64.dmg`
          - **Apple Silicon (M1/M2/M3) Mac**: ä¸‹è½½ `MoliTodo-*.arm64.dmg`
          
          ### Windows ç”¨æˆ·
          - ä¸‹è½½ `MoliTodo Setup *.exe`
          
          ğŸ’¡ **æç¤º**: å¦‚æœä¸ç¡®å®šä½ çš„ Mac èŠ¯ç‰‡ç±»å‹ï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¸Šè§’è‹¹æœèœå• > å…³äºæœ¬æœºæŸ¥çœ‹ã€‚
          
          ## ğŸ”„ å‡çº§è¯´æ˜
          
          - **è‡ªåŠ¨è¿ç§»**: é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨å‡çº§æ•°æ®åº“ï¼Œè¯·è€å¿ƒç­‰å¾…
          - **æ•°æ®å®‰å…¨**: å‡çº§å‰å»ºè®®å¯¼å‡ºæ•°æ®ä½œä¸ºå¤‡ä»½
          - **æ–°åŠŸèƒ½**: å‡çº§åå¯åœ¨å·¦ä¾§è¾¹æ ä½“éªŒæ¸…å•ç®¡ç†åŠŸèƒ½
          
          ## ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md