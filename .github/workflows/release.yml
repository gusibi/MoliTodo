name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} �
          
          ## ✨ 看板视图功能重磅发布
          
          ### � 全能新看板管理系统 (Kanban Board System)
          - **可视化任务流程**: 全新的四列看板布局（待办、进行中、暂停中、已完成），直观展示任务流转过程
          - **拖拽式状态管理**: 支持通过拖拽操作快速改变任务状态，操作更加直观高效
          - **智能状态追踪**: 拖拽操作自动触发相应的时间追踪功能（开始、暂停、完成等）
          - **实时任务统计**: 每列显示实时任务数量，快速了解各状态任务分布
          - **响应式设计**: 完美适配桌面、平板和移动设备，移动端支持横向滚动
          
          ### 🎯 看板核心组件架构
          - **KanbanBoard**: 看板主容器，管理四列布局和拖拽上下文
          - **KanbanColumn**: 单个看板列，处理特定状态任务显示和拖拽接收
          - **KanbanCard**: 任务卡片，显示完整任务信息并支持拖拽操作
          - **KanbanAddTask**: 快速任务添加组件，支持在指定状态列直接创建任务
          
          ## 🚀 用户体验革新
          
          ### 直观的任务管理
          - **状态可视化**: 四列布局清晰展示任务在不同阶段的分布情况
          - **拖拽操作**: 通过简单的拖拽动作即可改变任务状态，无需点击多个按钮
          - **即时反馈**: 拖拽过程中提供视觉反馈，操作结果立即可见
          - **批量管理**: 可以快速浏览和管理大量任务，提升工作效率
          
          ### 智能交互设计
          - **右键菜单**: 任务卡片支持右键菜单，提供编辑和删除等快捷操作
          - **空状态引导**: 各列提供友好的空状态提示和操作指导
          - **错误处理**: 拖拽失败时自动恢复，提供友好的错误提示
          - **键盘支持**: 支持键盘导航和无障碍访问
          
          ## 🔧 技术实现亮点
          
          ### 拖拽系统架构
          - **HTML5 Drag API**: 基于原生 HTML5 拖拽 API 实现，性能优异
          - **状态管理集成**: 与现有 TaskStore 无缝集成，保持数据一致性
          - **乐观更新**: 先更新 UI 后同步数据，提供流畅的用户体验
          - **冲突处理**: 智能处理并发操作和数据冲突
          
          ### 组件化设计
          - **模块化架构**: 采用组件化设计，便于维护和扩展
          - **Props/Events 通信**: 标准化的组件通信机制
          - **样式系统**: 完全基于 Tailwind CSS，支持主题切换
          - **类型安全**: 完整的 TypeScript 类型定义
          
          ### 性能优化策略
          - **虚拟滚动**: 大量任务时的性能优化
          - **防抖处理**: 拖拽事件的防抖处理，避免频繁操作
          - **懒加载**: 非关键组件的延迟加载
          - **内存管理**: 及时清理事件监听器，避免内存泄漏
          
          ## 🎨 视觉设计特色
          
          ### 现代化界面
          - **卡片式设计**: 采用现代化的卡片布局，信息层次清晰
          - **主题适配**: 完美支持明暗主题切换，保持视觉一致性
          - **动画效果**: 流畅的拖拽动画和状态转换效果
          - **图标系统**: 使用 Font Awesome 图标，提升视觉识别度
          
          ### 信息展示优化
          - **任务详情**: 卡片显示任务内容、时间信息、状态标识等完整信息
          - **时间追踪**: 实时显示任务进行时间、暂停时间等状态信息
          - **提醒标识**: 过期任务使用红色警示，即将到期任务特殊标识
          - **重复任务**: 重复任务显示专门的图标标识
          
          ## 🔄 升级说明
          
          ### 新功能使用
          1. **切换看板视图**: 在任务管理器中点击看板视图按钮
          2. **拖拽改变状态**: 将任务卡片拖拽到目标状态列
          3. **快速添加任务**: 在任意列底部快速添加新任务
          4. **编辑任务**: 点击任务卡片或使用右键菜单编辑
          
          ### 兼容性保证
          - **数据兼容**: 完全兼容现有任务数据和配置
          - **功能保持**: 所有现有功能保持不变，看板作为新增视图
          - **状态同步**: 看板操作与其他视图实时同步
          - **平滑升级**: 无需额外配置，升级后即可使用
          
          ## 📋 完整更新日志
          
          查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) 了解详细的更新内容。
          
          ---
          
          **正式版本发布**: 看板功能经过充分测试，现已稳定发布。这是 MoliTodo 在可视化任务管理方面的重大突破。
          
          感谢使用 MoliTodo！看板视图让任务管理变得更加直观和高效。如有问题或建议，欢迎在 GitHub 上反馈。
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md