name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} 🎨
          
          ## ✨ UI/UX 改进更新
          
          ### 🎨 设置界面优化 (Settings UI Enhancement)
          - **统一滚动条设计**: 使用 Tailwind CSS 实现一致的自定义滚动条样式
          - **精致视觉体验**: 滚动条采用细致的半透明设计，提升视觉美观度
          - **智能悬停效果**: 滚动条支持悬停状态变化，增强交互反馈
          - **跨组件一致性**: 设置页面所有滚动容器使用统一的样式标准
          - **性能优化**: 使用 CSS 变量和 Tailwind 工具类提升渲染性能
          
          ### 🔧 技术改进
          - **样式系统优化**: 使用 Tailwind CSS 的 @apply 指令实现模块化样式管理
          - **响应式设计**: 滚动条样式完美适配明暗主题切换
          - **浏览器兼容**: 优化的 webkit 滚动条样式确保跨浏览器一致性
          - **代码维护性**: 集中化的样式定义提升代码可维护性
          
          ## 🎯 用户体验提升
          
          ### 视觉一致性
          - **统一设计语言**: 所有设置区域采用一致的视觉设计标准
          - **细节打磨**: 精心调整的滚动条宽度、颜色和圆角设计
          - **主题适配**: 完美支持明暗主题下的视觉效果
          
          ### 交互体验
          - **流畅滚动**: 优化的滚动条样式提供更流畅的滚动体验
          - **视觉反馈**: 悬停状态提供清晰的交互反馈
          - **空间优化**: 精简的滚动条设计节省界面空间
          
          ## 🔄 升级说明
          
          - **无缝升级**: 完全兼容现有配置和数据
          - **立即生效**: 升级后设置界面立即应用新的视觉样式
          - **性能提升**: 优化的 CSS 实现提升界面渲染性能
          - **向后兼容**: 保持所有现有功能和配置不变
          
          ## 📋 完整更新日志
          
          查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) 了解详细的更新内容。
          
          ---
          
          感谢使用 MoliTodo！AI 智能功能让任务管理更加高效便捷。如有问题或建议，欢迎在 GitHub 上反馈。
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md