name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ðŸš€
          
          ## ðŸŽ‰ é‡å¤§åŠŸèƒ½æ›´æ–°
          
          ### ðŸ”„ é‡å¤ä»»åŠ¡ç³»ç»Ÿ
          - **å…¨é¢é‡å¤æ”¯æŒ**: æ”¯æŒæ—¥ã€å‘¨ã€æœˆã€å¹´å››ç§é‡å¤ç±»åž‹
          - **çµæ´»é…ç½®**: è‡ªå®šä¹‰é—´éš”ã€å¤šæ—¥æœŸé€‰æ‹©ã€ç»“æŸæ¡ä»¶è®¾ç½®
          - **æ™ºèƒ½ç®¡ç†**: ç³»åˆ—ä»»åŠ¡ç»Ÿä¸€ç®¡ç†ï¼Œæ”¯æŒå•ç‹¬ç¼–è¾‘å®žä¾‹
          - **æé†’é›†æˆ**: é‡å¤ä»»åŠ¡ç³»åˆ—ç»Ÿä¸€æé†’æ—¶é—´è®¾ç½®
          
          ### ðŸ“ ä»»åŠ¡å¤‡æ³¨åŠŸèƒ½
          - **è¯¦ç»†å¤‡æ³¨**: æ”¯æŒ1000å­—ç¬¦çš„ä»»åŠ¡å¤‡æ³¨å†…å®¹
          - **æœç´¢æ”¯æŒ**: å¤‡æ³¨å†…å®¹æ”¯æŒæœç´¢å’Œé«˜äº®æ˜¾ç¤º
          - **ç¼–è¾‘ä¼˜åŒ–**: é›†æˆåˆ°ä»»åŠ¡ç¼–è¾‘æµç¨‹ï¼Œæ”¯æŒè‡ªåŠ¨é«˜åº¦è°ƒæ•´
          
          ### ðŸŽ¨ ç¼–è¾‘ä½“éªŒä¼˜åŒ–
          - **ç»Ÿä¸€ç¼–è¾‘ç•Œé¢**: TaskEditVerticalæ”¯æŒæ–°å¢žå’Œç¼–è¾‘åŒæ¨¡å¼
          - **RepeatSelectorç»„ä»¶**: å…¨æ–°çš„é‡å¤è§„åˆ™é…ç½®ç•Œé¢
          - **æ™ºèƒ½é»˜è®¤å€¼**: æ ¹æ®å½“å‰æ—¥æœŸæ™ºèƒ½è®¾ç½®é‡å¤è§„åˆ™
          - **å®žæ—¶é¢„è§ˆ**: é‡å¤è§„åˆ™é…ç½®å®žæ—¶é¢„è§ˆå’Œæè¿°
          
          ## ðŸ› ï¸ æŠ€æœ¯æ”¹è¿›
          
          - **æž¶æž„å‡çº§**: æ–°å¢žRecurringTaskServiceé¢†åŸŸæœåŠ¡
          - **æ•°æ®æ¨¡åž‹**: æ‰©å±•Taskå®žä½“æ”¯æŒé‡å¤ä»»åŠ¡å’Œå¤‡æ³¨
          - **çŠ¶æ€ç®¡ç†**: ä¼˜åŒ–é‡å¤ä»»åŠ¡çš„çŠ¶æ€ç®¡ç†å’Œæ•°æ®åŒæ­¥
          - **æ€§èƒ½ä¼˜åŒ–**: é‡å¤ä»»åŠ¡å®žä¾‹æŒ‰éœ€åŠ è½½ï¼Œæå‡æ¸²æŸ“æ€§èƒ½
          
          ## ðŸ“‹ ä½¿ç”¨è¯´æ˜Ž
          
          ### åˆ›å»ºé‡å¤ä»»åŠ¡
          1. åœ¨ä»»åŠ¡ç¼–è¾‘ç•Œé¢å¼€å¯"é‡å¤"å¼€å…³
          2. é€‰æ‹©é‡å¤ç±»åž‹ï¼ˆæ—¥/å‘¨/æœˆ/å¹´ï¼‰
          3. é…ç½®é‡å¤è§„åˆ™å’Œç»“æŸæ¡ä»¶
          4. è®¾ç½®æé†’æ—¶é—´ï¼ˆå¯é€‰ï¼‰
          
          ### æ·»åŠ ä»»åŠ¡å¤‡æ³¨
          1. åœ¨ä»»åŠ¡ç¼–è¾‘ç•Œé¢æ‰¾åˆ°å¤‡æ³¨åŒºåŸŸ
          2. è¾“å…¥æœ€å¤š1000å­—ç¬¦çš„å¤‡æ³¨å†…å®¹
          3. ä¿å­˜åŽå¤‡æ³¨å°†åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­æ˜¾ç¤º
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          - **æ•°æ®å…¼å®¹**: å®Œå…¨å‘åŽå…¼å®¹ï¼ŒçŽ°æœ‰æ•°æ®è‡ªåŠ¨è¿ç§»
          - **åŠŸèƒ½æ¿€æ´»**: å‡çº§åŽæ–°åŠŸèƒ½ç«‹å³å¯ç”¨
          - **æ¸è¿›å¼**: å¯é€‰æ‹©æ€§å¯ç”¨é‡å¤åŠŸèƒ½
          
          ## ðŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼é‡å¤ä»»åŠ¡å’Œå¤‡æ³¨åŠŸèƒ½è®©ä»»åŠ¡ç®¡ç†æ›´åŠ é«˜æ•ˆä¾¿æ·ã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md