name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} âœ¨
          
          ## ðŸ¥š éšè—åŠŸèƒ½å½©è›‹å‘å¸ƒ - æ•°æ®åº“ä»»åŠ¡è¯¦æƒ…è§†å›¾
          
          MoliTodo v1.0.2 å¸¦æ¥äº†ä¸€ä¸ªç‰¹æ®Šçš„éšè—åŠŸèƒ½ï¼Œä¸“ä¸ºå¼€å‘è€…å’Œé«˜çº§ç”¨æˆ·è®¾è®¡ã€‚è¿™ä¸ªå½©è›‹åŠŸèƒ½æä¾›äº†å¯¹åº”ç”¨æ•°æ®å­˜å‚¨å±‚çš„å®Œæ•´é€æ˜Žè®¿é—®ï¼Œè®©æ‚¨èƒ½å¤Ÿæ·±å…¥äº†è§£ä»»åŠ¡æ•°æ®çš„å†…éƒ¨ç»“æž„ã€‚
          
          ### ðŸŽ macOS ç”¨æˆ·é‡è¦æç¤º
          
          ç”±äºŽåº”ç”¨æœªç»è¿‡ Apple å¼€å‘è€…è®¤è¯ï¼ŒmacOS ç”¨æˆ·åœ¨é¦–æ¬¡è¿è¡Œæˆ–æ¯æ¬¡æ›´æ–°åŽå¯èƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç§»é™¤ç³»ç»Ÿéš”ç¦»é™åˆ¶ï¼š
          
          ```bash
          sudo xattr -rd com.apple.quarantine /Applications/MoliTodo.app
          ```
          
          **æ‰§è¡Œæ—¶æœº**:
          - é¦–æ¬¡å®‰è£…åŽ
          - æ¯æ¬¡åº”ç”¨æ›´æ–°åŽ
          - é‡åˆ°"æ— æ³•æ‰“å¼€åº”ç”¨ç¨‹åº"æç¤ºæ—¶
          
          **æ“ä½œæ­¥éª¤**:
          1. æ‰“å¼€ç»ˆç«¯ï¼ˆTerminalï¼‰
          2. å¤åˆ¶ç²˜è´´ä¸Šè¿°å‘½ä»¤
          3. è¾“å…¥ç®¡ç†å‘˜å¯†ç ç¡®è®¤
          4. é‡æ–°å¯åŠ¨ MoliTodo
          
          ### ðŸ“¥ ä¸‹è½½å’Œå®‰è£…
          
          ### ðŸŽ¯ å½©è›‹æ¿€æ´»æ–¹å¼
          
          **è¿žç»­ç‚¹å‡» 5 æ¬¡é¼ æ ‡**å³å¯æ¿€æ´»éšè—çš„æ•°æ®åº“è§†å›¾åŠŸèƒ½ï¼è¿™ä¸ªç‰¹æ®Šçš„è§¦å‘æœºåˆ¶ä¸ºåº”ç”¨å¢žæ·»äº†æŽ¢ç´¢çš„ä¹è¶£ã€‚
          
          ### ðŸ“Š æ•°æ®åº“è¯¦æƒ…è§†å›¾æ ¸å¿ƒç‰¹æ€§
          
          #### å®Œæ•´æ•°æ®å±•ç¤º
          - **åŽŸå§‹æ•°æ®åº“å­—æ®µ**: å±•ç¤ºæ‰€æœ‰ä»»åŠ¡çš„åŽŸå§‹æ•°æ®åº“å­—æ®µï¼ŒåŒ…æ‹¬å†…éƒ¨å…ƒæ•°æ®å’Œç³»ç»Ÿå­—æ®µ
          - **è¡¨æ ¼åŒ–å¸ƒå±€**: ä¸“ä¸šçš„è¡¨æ ¼è®¾è®¡ï¼Œæ•°æ®å±‚æ¬¡æ¸…æ¥šï¼Œæ”¯æŒåˆ†é¡µæµè§ˆ
          - **å­—æ®µå®Œæ•´æ€§**: æ˜¾ç¤ºåŒ…æ‹¬ `id`ã€`content`ã€`status`ã€`metadata`ã€`recurrence` ç­‰æ‰€æœ‰æ•°æ®åº“å­—æ®µ
          - **å¤æ‚å­—æ®µæŸ¥çœ‹**: JSON å­—æ®µå’Œé•¿æ–‡æœ¬æä¾›ä¸“é—¨çš„è¯¦æƒ…å¼¹çª—æŸ¥çœ‹
         
          
          ### ðŸ” ä½¿ç”¨æŒ‡å—
          
          #### æ¿€æ´»æ–¹æ³•
          1. **æ‰¾åˆ°è§¦å‘åŒºåŸŸ**: åœ¨åº”ç”¨çš„ä»»ä½•ä½ç½®éƒ½å¯ä»¥æ¿€æ´»å½©è›‹
          2. **è¿žç»­ç‚¹å‡»**: ç”¨é¼ æ ‡å¿«é€Ÿè¿žç»­ç‚¹å‡» 5 æ¬¡
          3. **åŠŸèƒ½æ¿€æ´»**: æˆåŠŸæ¿€æ´»åŽä¼šè‡ªåŠ¨æ˜¾ç¤ºæ•°æ®åº“è§†å›¾æ¨¡æ€æ¡†
          4. **æµè§ˆæ•°æ®**: ä½¿ç”¨åˆ†é¡µæŽ§ä»¶æµè§ˆæ‰€æœ‰ä»»åŠ¡æ•°æ®åº“è®°å½•
          5. **æŸ¥çœ‹è¯¦æƒ…**: å¤æ‚å­—æ®µç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æŒ‰é’®æŸ¥çœ‹å®Œæ•´å†…å®¹
          
          #### åŠŸèƒ½ç‰¹è‰²
          - **åªè¯»è®¿é—®**: æä¾›åªè¯»çš„æ•°æ®è®¿é—®ï¼Œç¡®ä¿ä¸ä¼šæ„å¤–ä¿®æ”¹æ•°æ®
          - **å®Œæ•´å±•ç¤º**: å±•ç¤ºä»»åŠ¡åœ¨æ•°æ®åº“ä¸­çš„çœŸå®žå­˜å‚¨æ ¼å¼
          - **å¼€å‘å‹å¥½**: ä¸ºå¼€å‘è€…å’ŒæŠ€æœ¯ç”¨æˆ·æä¾›æœ‰ä»·å€¼çš„å†…éƒ¨è§†å›¾
          - **æ•™è‚²æ„ä¹‰**: å¸®åŠ©ç†è§£çŽ°ä»£ Web åº”ç”¨çš„æ•°æ®æž¶æž„è®¾è®¡
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          ### æ— ç¼é›†æˆ
          - **é›¶å½±å“å‡çº§**: å½©è›‹åŠŸèƒ½å¯¹çŽ°æœ‰åŠŸèƒ½æ— ä»»ä½•å½±å“
          - **å¯é€‰å‘çŽ°**: åŠŸèƒ½å®Œå…¨å¯é€‰ï¼Œä¸å¹²æ‰°æ­£å¸¸ä½¿ç”¨æµç¨‹
          - **æ•°æ®å®‰å…¨**: åªæä¾›åªè¯»è®¿é—®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
          - **æ€§èƒ½ä¸­æ€§**: ä¸ä½¿ç”¨æ—¶å¯¹ä¸»åº”ç”¨æ— æ€§èƒ½å½±å“
          
          ### å…¼å®¹æ€§ä¿è¯
          - **å®Œå…¨å‘åŽå…¼å®¹**: æ‰€æœ‰çŽ°æœ‰æ•°æ®å’Œé…ç½®å®Œå…¨ä¿ç•™
          - **åŠŸèƒ½å¢žå¼º**: åœ¨çŽ°æœ‰åŠŸèƒ½åŸºç¡€ä¸Šæ–°å¢žè°ƒè¯•åŠŸèƒ½
          - **å³æ—¶å¯ç”¨**: å‡çº§åŽç«‹å³å¯ä»¥å°è¯•å½©è›‹åŠŸèƒ½
          
          
          
          ## ðŸ™ ç¤¾åŒºæ„Ÿè°¢
          
          æ„Ÿè°¢æ‰€æœ‰å¥½å¥‡å’ŒæŽ¢ç´¢çš„ç”¨æˆ·ï¼æ­£æ˜¯å› ä¸ºæœ‰æ‚¨ä»¬çš„æ”¯æŒå’ŒæŽ¢ç´¢ç²¾ç¥žï¼Œæˆ‘ä»¬æ‰èƒ½ä¸æ–­åˆ›æ–°ï¼Œä¸ºåº”ç”¨æ·»åŠ è¿™æ ·æœ‰è¶£ä¸”æœ‰ä»·å€¼çš„åŠŸèƒ½ã€‚
          
          è¿™ä¸ªå½©è›‹åŠŸèƒ½ä¸ä»…æ˜¯ä¸€ä¸ªæŠ€æœ¯å±•ç¤ºï¼Œæ›´æ˜¯æˆ‘ä»¬ä¸Žç”¨æˆ·å»ºç«‹æ›´æ·±å±‚è¿žæŽ¥çš„æ–¹å¼ã€‚æˆ‘ä»¬ç›¸ä¿¡é€æ˜Žåº¦å’Œå¼€æ”¾æ€§æ˜¯æž„å»ºä¼˜ç§€è½¯ä»¶çš„åŸºç¡€ã€‚
          
          ---
          
          **ç«‹å³ä½“éªŒ**: [ä¸‹è½½ MoliTodo v${{ steps.get_version.outputs.VERSION }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }})  
          **åŠŸèƒ½æ–‡æ¡£**: [æ•°æ®åº“è§†å›¾ä½¿ç”¨æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/docs/releases/v${{ steps.get_version.outputs.VERSION }}.md)  
          **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/${{ github.repository }}/issues)  
          **ç¤¾åŒºè®¨è®º**: [å¼€å‘è€…è®ºå›](https://github.com/${{ github.repository }}/discussions)
          
          **MoliTodo v${{ steps.get_version.outputs.VERSION }} - æŽ¢ç´¢æ•°æ®çš„å¥¥ç§˜ï¼Œå‘çŽ°éšè—çš„æƒŠå–œï¼ðŸ¥š**
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md