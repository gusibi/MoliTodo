name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1
      - name: Setup Visual Studio Build Tools
        run: |
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --includeOptional --passive"
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} âœ¨
          
          ## âš ï¸ é‡è¦å‡çº§æé†’
          
          **å‡çº§å‰è¯·åŠ¡å¿…å¤‡ä»½æ•°æ®ï¼**
          
          1. **å‡çº§å‰å¤‡ä»½**: å»ºè®®åœ¨å‡çº§å‰å…ˆå¯¼å‡ºæ‚¨çš„ä»»åŠ¡æ•°æ®
             - æ‰“å¼€åº”ç”¨ â†’ è®¾ç½® â†’ æ•°æ®ç®¡ç† â†’ å¯¼å‡ºä»»åŠ¡
             - ä¿å­˜å¯¼å‡ºçš„æ–‡ä»¶åˆ°å®‰å…¨ä½ç½®
          
          2. **å‡çº§åŽéªŒè¯**: å‡çº§å®ŒæˆåŽè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
             - ç¡®è®¤ä»»åŠ¡æ•°æ®å®Œæ•´
             - æµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ä»»åŠ¡ï¼‰
          
          3. **é—®é¢˜æ¢å¤**: å¦‚æžœå‡çº§åŽé‡åˆ°é—®é¢˜
             - ä½¿ç”¨ä¹‹å‰å¯¼å‡ºçš„ä»»åŠ¡æ–‡ä»¶è¿›è¡Œæ¢å¤
             - è®¾ç½® â†’ æ•°æ®ç®¡ç† â†’ å¯¼å…¥ä»»åŠ¡
             - æˆ–è”ç³»æŠ€æœ¯æ”¯æŒèŽ·å–å¸®åŠ©: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          ## ðŸ”§ Windows SQLite å…¼å®¹æ€§ä¸Žæ€§èƒ½ä¼˜åŒ–
          
          ### å…³é”®é”™è¯¯ä¿®å¤
          - **Windows SQLite å…¼å®¹æ€§**: ä¿®å¤äº† Windows ç³»ç»Ÿä¸Šçš„ `getLastUpdatedTime is not a function` é”™è¯¯
          - **æ•°æ®åº“åˆå§‹åŒ–**: å¢žå¼ºäº† SQLite åˆå§‹åŒ–ï¼Œæ”¯æŒ Windows ç‰¹å®šçš„æ–‡ä»¶é”å®šå’Œæƒé™æ£€æŸ¥
          - **è·¨å¹³å°è·¯å¾„å¤„ç†**: æ”¹è¿›äº†è·¯å¾„æ ‡å‡†åŒ–ï¼Œæå‡ Windows å…¼å®¹æ€§
          - **è¿ç§»é¡ºåº**: ä¿®å¤äº†æ•°æ®åº“è¿ç§»åºåˆ—ï¼Œé˜²æ­¢è¡¨åˆ›å»ºé”™è¯¯
          
          ### æ€§èƒ½æ”¹è¿›
          - **SQLite ä¼˜åŒ–**: æ·»åŠ äº† Windows ç‰¹å®šçš„ SQLite å‚æ•°ä»¥æå‡æ€§èƒ½
          - **é”™è¯¯å¤„ç†**: å¢žå¼ºäº†æ•°æ®åº“é”™è¯¯è¯Šæ–­å’Œæ—¥å¿—è®°å½•
          - **æ–‡ä»¶ç³»ç»Ÿ**: æ”¹è¿›äº†æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œæ”¯æŒæ­£ç¡®çš„ Windows è·¯å¾„å¤„ç†
          - **æ•°æ®å®Œæ•´æ€§**: åŠ å¼ºäº†æ•°æ®éªŒè¯å’Œä¸€è‡´æ€§æ£€æŸ¥
          
          ### ðŸŽ macOS å®‰è£…è¯´æ˜Ž
          
          ç”±äºŽä»£ç æœªç­¾åï¼ŒmacOS ç”¨æˆ·éœ€è¦åœ¨å®‰è£…åŽè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
          
          ```bash
          sudo xattr -rd com.apple.quarantine /Applications/MoliTodo.app
          ```
          
          è¯·åœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œæ­¤å‘½ä»¤ï¼š
          - é¦–æ¬¡å®‰è£…åŽ
          - æ¯æ¬¡æ›´æ–°åŽ
          - å¦‚æžœçœ‹åˆ°"æ— æ³•æ‰“å¼€åº”ç”¨ç¨‹åº"é”™è¯¯
          
          ### ðŸ“¥ ä¸‹è½½
          
          - **macOS**: é€‰æ‹©é€‚åˆæ‚¨ Mac çš„ç‰ˆæœ¬ï¼ˆIntel/Apple Siliconï¼‰
          - **Windows**: Windows 10+ é€šç”¨å®‰è£…ç¨‹åº
          
          ### ä¸»è¦æ”¹è¿›
          
          - **Windows å…¼å®¹æ€§**: è§£å†³äº† Windows ç³»ç»Ÿä¸Šçš„å…³é”® SQLite æ•°æ®åº“é”™è¯¯
          - **æ•°æ®åº“æ€§èƒ½**: å¢žå¼ºäº†æ‰€æœ‰å¹³å°çš„ SQLite åˆå§‹åŒ–å’Œä¼˜åŒ–
          - **é”™è¯¯è¯Šæ–­**: æ”¹è¿›äº†é”™è¯¯å¤„ç†ï¼Œæä¾›è¯¦ç»†çš„æ—¥å¿—å’Œè¯Šæ–­ä¿¡æ¯
          - **è·¨å¹³å°æ”¯æŒ**: æ›´å¥½çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œæ”¯æŒ Windowsã€macOS å’Œ Linux
          - **æ•°æ®å®Œæ•´æ€§**: åŠ å¼ºäº†æ•°æ®åº“éªŒè¯å’Œä¸€è‡´æ€§æ£€æŸ¥
          
          ### æŠ€æœ¯ç»†èŠ‚
          
          æ­¤ç‰ˆæœ¬è§£å†³äº† Windows ç”¨æˆ·é‡åˆ°çš„ `getLastUpdatedTime is not a function` é”™è¯¯ï¼Œè¯¥é”™è¯¯æ˜¯ç”±äºŽ SQLite åˆå§‹åŒ–ä¸å®Œæ•´å¯¼è‡´çš„ã€‚ä¿®å¤åŒ…æ‹¬ï¼š
          
          - å¢žå¼ºæ•°æ®åº“åˆå§‹åŒ–é¡ºåº
          - Windows ç‰¹å®šçš„ SQLite é…ç½®
          - æ”¹è¿›çš„è·¨å¹³å°è·¯å¾„å¤„ç†
          - æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œè¯Šæ–­
          
          ### å‡çº§è¯´æ˜Ž
          
          - æ‰€æœ‰çŽ°æœ‰æ•°æ®å’Œè®¾ç½®éƒ½ä¼šä¿ç•™
          - Windows ç”¨æˆ·å°†ä¸å†é‡åˆ° SQLite æ•°æ®åº“é”™è¯¯
          - æ‰€æœ‰å¹³å°çš„æ•°æ®åº“æ€§èƒ½éƒ½æœ‰æå‡
          - æ— éœ€é…ç½® - ä¿®å¤ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
          
          ---
          
          **å®Œæ•´æ–‡æ¡£**: [å‘å¸ƒè¯´æ˜Ž](https://github.com/${{ github.repository }}/blob/main/docs/releases/v${{ steps.get_version.outputs.VERSION }}.md)
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md