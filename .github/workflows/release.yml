name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ðŸ”
          
          ## âœ¨ è®¡åˆ’è§†å›¾æ—¶é—´ç­›é€‰åŠŸèƒ½å‘å¸ƒ
          
          ### ðŸ” æ™ºèƒ½æ—¶é—´ç­›é€‰ç³»ç»Ÿ (Time Filter System)
          - **å¤šç»´åº¦ç­›é€‰**: æ–°å¢žå…¨éƒ¨ã€è¿‡æœŸã€ä»Šå¤©ã€æ˜Žå¤©ã€æœ¬å‘¨ç­‰å¤šç§æ—¶é—´ç»´åº¦ç­›é€‰
          - **å®žæ—¶è®¡æ•°æ˜¾ç¤º**: å„ç­›é€‰é€‰é¡¹å®žæ—¶æ˜¾ç¤ºå¯¹åº”çš„ä»»åŠ¡æ•°é‡ï¼Œä¾¿äºŽå¿«é€Ÿäº†è§£ä»»åŠ¡åˆ†å¸ƒ
          - **è¿‡æœŸä»»åŠ¡è­¦ç¤º**: è¿‡æœŸä»»åŠ¡ä½¿ç”¨çº¢è‰²è­¦ç¤ºæ ·å¼ï¼Œæå‡è§†è§‰è¯†åˆ«åº¦å’Œç´§æ€¥æ€§
          - **å“åº”å¼è®¾è®¡**: ç­›é€‰æŒ‰é’®é‡‡ç”¨å“åº”å¼å¸ƒå±€ï¼Œå®Œç¾Žé€‚é…ä¸åŒå±å¹•å°ºå¯¸
          - **ä¸»é¢˜é€‚é…**: å®Œç¾Žæ”¯æŒæ˜Žæš—ä¸»é¢˜åˆ‡æ¢ï¼Œä¿æŒè§†è§‰ä¸€è‡´æ€§
          
          ### ðŸ› ï¸ TimeFilter ç»„ä»¶ç‰¹æ€§
          - **Vue 3 ç»„åˆå¼ API**: ä½¿ç”¨çŽ°ä»£åŒ–çš„ Vue 3 Composition API æž„å»º
          - **åŒå‘æ•°æ®ç»‘å®š**: æ”¯æŒ v-model æ¨¡å¼ï¼Œä¸Žçˆ¶ç»„ä»¶æ— ç¼æ•°æ®åŒæ­¥
          - **äº‹ä»¶é©±åŠ¨æž¶æž„**: åŸºäºŽäº‹ä»¶çš„ç­›é€‰å˜æ›´æœºåˆ¶ï¼Œç¡®ä¿çŠ¶æ€å®žæ—¶æ›´æ–°
          - **è®¡ç®—å±žæ€§ä¼˜åŒ–**: ä½¿ç”¨è®¡ç®—å±žæ€§ä¼˜åŒ–ä»»åŠ¡è®¡æ•°æ€§èƒ½ï¼Œé¿å…é‡å¤è®¡ç®—
          - **Font Awesome å›¾æ ‡**: æ¯ä¸ªç­›é€‰é€‰é¡¹é…å¤‡ç›´è§‚çš„å›¾æ ‡æ ‡è¯†
          
          ## ðŸŽ¯ ç”¨æˆ·ä»·å€¼æå‡
          
          ### ä»»åŠ¡ç®¡ç†æ•ˆçŽ‡é©å‘½
          - **å¿«é€Ÿå®šä½**: é€šè¿‡æ—¶é—´ç­›é€‰å¿«é€Ÿå®šä½ç‰¹å®šæ—¶é—´èŒƒå›´å†…çš„ä»»åŠ¡
          - **ä¼˜å…ˆçº§è¯†åˆ«**: è¿‡æœŸä»»åŠ¡çš„é†’ç›®æ ‡è¯†å¸®åŠ©ç”¨æˆ·è¯†åˆ«ç´§æ€¥ä»»åŠ¡
          - **æ•°æ®å¯è§†åŒ–**: ä»»åŠ¡è®¡æ•°æä¾›ç›´è§‚çš„ä»»åŠ¡åˆ†å¸ƒæ•°æ®
          - **å·¥ä½œæµä¼˜åŒ–**: æ”¯æŒæŒ‰æ—¶é—´ç»´åº¦ç»„ç»‡å’Œç®¡ç†å·¥ä½œæµç¨‹
          
          ### ä½¿ç”¨ä½“éªŒæ”¹å–„
          - **æ“ä½œç®€ä¾¿**: ä¸€é”®åˆ‡æ¢ä¸åŒæ—¶é—´ç»´åº¦çš„ä»»åŠ¡è§†å›¾
          - **ä¿¡æ¯æ¸…æ™°**: æ¸…æ™°çš„è§†è§‰å±‚æ¬¡å’Œä¿¡æ¯ç»„ç»‡
          - **å“åº”è¿…é€Ÿ**: ç­›é€‰æ“ä½œå³æ—¶å“åº”ï¼Œæ— å»¶è¿Ÿæ„Ÿ
          - **ä¹ æƒ¯å‹å¥½**: ç¬¦åˆç”¨æˆ·ä¹ æƒ¯çš„ç­›é€‰é€»è¾‘å’Œç•Œé¢è®¾è®¡
          
          ## ðŸ”§ æŠ€æœ¯å®žçŽ°äº®ç‚¹
          
          ### ç­›é€‰ç»´åº¦è¯¦è§£
          - **å…¨éƒ¨ä»»åŠ¡**: æ˜¾ç¤ºå½“å‰æ¸…å•ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œä¸è¿›è¡Œæ—¶é—´ç­›é€‰
          - **è¿‡æœŸä»»åŠ¡**: è¯†åˆ«æé†’æ—¶é—´æ—©äºŽå½“å‰æ—¶é—´çš„ä»»åŠ¡ï¼Œçº¢è‰²è­¦ç¤ºæ˜¾ç¤º
          - **ä»Šå¤©ä»»åŠ¡**: ä»Šå¤©åˆ›å»ºæˆ–ä»Šå¤©éœ€è¦æé†’çš„ä»»åŠ¡ï¼Œæ”¯æŒæ—¥å¸¸è§„åˆ’
          - **æ˜Žå¤©ä»»åŠ¡**: æ˜Žå¤©éœ€è¦å¤„ç†æˆ–æé†’çš„ä»»åŠ¡ï¼Œå¸®åŠ©æå‰è§„åˆ’
          - **æœ¬å‘¨ä»»åŠ¡**: æœ¬å‘¨å†…éœ€è¦å¤„ç†çš„æ‰€æœ‰ä»»åŠ¡ï¼Œæ”¯æŒå‘¨æœŸç®¡ç†
          
          ### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
          - **è®¡ç®—å±žæ€§ç¼“å­˜**: åˆ©ç”¨ Vue 3 çš„è®¡ç®—å±žæ€§ç¼“å­˜æœºåˆ¶
          - **å¢žé‡æ›´æ–°**: åªåœ¨ä»»åŠ¡æ•°æ®å˜åŒ–æ—¶é‡æ–°è®¡ç®—è®¡æ•°
          - **å“åº”å¼ç›‘å¬**: ç›‘å¬ä»»åŠ¡æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°è®¡æ•°
          - **å†…å­˜ç®¡ç†**: é«˜æ•ˆçš„å†…å­˜ä½¿ç”¨å’Œåžƒåœ¾å›žæ”¶æœºåˆ¶
          
          ## ðŸš€ åº”ç”¨åœºæ™¯
          
          ### æ—¥å¸¸ä»»åŠ¡ç®¡ç†
          - **ä»Šæ—¥èšç„¦**: ä½¿ç”¨"ä»Šå¤©"ç­›é€‰ä¸“æ³¨äºŽå½“æ—¥ä»»åŠ¡
          - **åº”æ€¥å¤„ç†**: ä½¿ç”¨"è¿‡æœŸ"ç­›é€‰å¿«é€Ÿè¯†åˆ«ç´§æ€¥ä»»åŠ¡
          - **æå‰è§„åˆ’**: ä½¿ç”¨"æ˜Žå¤©"ç­›é€‰æå‰å®‰æŽ’æ˜Žæ—¥å·¥ä½œ
          - **å‘¨åº¦è®¡åˆ’**: ä½¿ç”¨"æœ¬å‘¨"ç­›é€‰è¿›è¡Œå‘¨æœŸæ€§è§„åˆ’
          
          ### å·¥ä½œæ•ˆçŽ‡æå‡
          - **ä¼˜å…ˆçº§ç®¡ç†**: é€šè¿‡è¿‡æœŸä»»åŠ¡æ ‡è¯†è¿›è¡Œä¼˜å…ˆçº§ç®¡ç†
          - **æ—¶é—´åˆ†é…**: æ ¹æ®ä»»åŠ¡è®¡æ•°åˆç†åˆ†é…æ—¶é—´å’Œç²¾åŠ›
          - **è¿›åº¦è·Ÿè¸ª**: é€šè¿‡ä¸åŒæ—¶é—´ç»´åº¦è·Ÿè¸ªä»»åŠ¡å®Œæˆè¿›åº¦
          - **å·¥ä½œèŠ‚å¥**: å»ºç«‹æ›´å¥½çš„å·¥ä½œèŠ‚å¥å’Œæ—¶é—´ç®¡ç†ä¹ æƒ¯
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          ### æ–°åŠŸèƒ½ä½¿ç”¨
          1. **æ‰“å¼€è®¡åˆ’è§†å›¾**: åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­é€‰æ‹©"è®¡åˆ’ä¸­"åˆ†ç±»
          2. **ä½¿ç”¨æ—¶é—´ç­›é€‰**: åœ¨é¡¶éƒ¨ç­›é€‰æ ä¸­é€‰æ‹©éœ€è¦çš„æ—¶é—´ç»´åº¦
          3. **æŸ¥çœ‹ä»»åŠ¡è®¡æ•°**: è§‚å¯Ÿå„ç­›é€‰é€‰é¡¹çš„ä»»åŠ¡æ•°é‡ç»Ÿè®¡
          4. **å¿«é€Ÿåˆ‡æ¢**: åœ¨ä¸åŒæ—¶é—´ç»´åº¦é—´å¿«é€Ÿåˆ‡æ¢æŸ¥çœ‹
          
          - **æ— ç¼å‡çº§**: å®Œå…¨å…¼å®¹çŽ°æœ‰é…ç½®å’Œæ•°æ®
          - **åŠŸèƒ½å¢žå¼º**: åœ¨åŽŸæœ‰åŠŸèƒ½åŸºç¡€ä¸Šå¢žåŠ æ–°çš„ç­›é€‰èƒ½åŠ›
          - **æ€§èƒ½æå‡**: ä¼˜åŒ–çš„ç­›é€‰ç®—æ³•æå‡æ•´ä½“æ€§èƒ½
          - **å‘åŽå…¼å®¹**: ä¿æŒæ‰€æœ‰çŽ°æœ‰åŠŸèƒ½å’Œè¡Œä¸ºä¸å˜
          
          ## ðŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          **Release Candidate è¯´æ˜Ž**: è¿™æ˜¯ä¸€ä¸ªå‘å¸ƒå€™é€‰ç‰ˆæœ¬ï¼Œæ—¶é—´ç­›é€‰åŠŸèƒ½å·²ç»ç¨³å®šï¼Œæ¬¢è¿Žç”¨æˆ·æµ‹è¯•å¹¶æä¾›åé¦ˆã€‚
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼æ™ºèƒ½æ—¶é—´ç­›é€‰è®©ä»»åŠ¡ç®¡ç†å˜å¾—æ›´åŠ é«˜æ•ˆå’Œä¾¿æ·ã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md