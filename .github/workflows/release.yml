name: Build on Tag
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python (macOS)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: npm install
      - run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          PYTHON_PATH: /usr/bin/python3
          npm_config_python: /usr/bin/python3
      - name: List build artifacts
        run: ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/
      - uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: dist/
      - name: List all artifacts
        run: ls -la dist/
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MoliTodo v${{ steps.get_version.outputs.VERSION }} ðŸŽ¨
          
          ## âœ¨ UI/UX æ”¹è¿›æ›´æ–°
          
          ### ðŸŽ¨ è®¾ç½®ç•Œé¢ä¼˜åŒ– (Settings UI Enhancement)
          - **ç»Ÿä¸€æ»šåŠ¨æ¡è®¾è®¡**: ä½¿ç”¨ Tailwind CSS å®žçŽ°ä¸€è‡´çš„è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼
          - **ç²¾è‡´è§†è§‰ä½“éªŒ**: æ»šåŠ¨æ¡é‡‡ç”¨ç»†è‡´çš„åŠé€æ˜Žè®¾è®¡ï¼Œæå‡è§†è§‰ç¾Žè§‚åº¦
          - **æ™ºèƒ½æ‚¬åœæ•ˆæžœ**: æ»šåŠ¨æ¡æ”¯æŒæ‚¬åœçŠ¶æ€å˜åŒ–ï¼Œå¢žå¼ºäº¤äº’åé¦ˆ
          - **è·¨ç»„ä»¶ä¸€è‡´æ€§**: è®¾ç½®é¡µé¢æ‰€æœ‰æ»šåŠ¨å®¹å™¨ä½¿ç”¨ç»Ÿä¸€çš„æ ·å¼æ ‡å‡†
          - **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ CSS å˜é‡å’Œ Tailwind å·¥å…·ç±»æå‡æ¸²æŸ“æ€§èƒ½
          
          ### ðŸ”§ æŠ€æœ¯æ”¹è¿›
          - **æ ·å¼ç³»ç»Ÿä¼˜åŒ–**: ä½¿ç”¨ Tailwind CSS çš„ @apply æŒ‡ä»¤å®žçŽ°æ¨¡å—åŒ–æ ·å¼ç®¡ç†
          - **å“åº”å¼è®¾è®¡**: æ»šåŠ¨æ¡æ ·å¼å®Œç¾Žé€‚é…æ˜Žæš—ä¸»é¢˜åˆ‡æ¢
          - **æµè§ˆå™¨å…¼å®¹**: ä¼˜åŒ–çš„ webkit æ»šåŠ¨æ¡æ ·å¼ç¡®ä¿è·¨æµè§ˆå™¨ä¸€è‡´æ€§
          - **ä»£ç ç»´æŠ¤æ€§**: é›†ä¸­åŒ–çš„æ ·å¼å®šä¹‰æå‡ä»£ç å¯ç»´æŠ¤æ€§
          
          ## ðŸŽ¯ ç”¨æˆ·ä½“éªŒæå‡
          
          ### è§†è§‰ä¸€è‡´æ€§
          - **ç»Ÿä¸€è®¾è®¡è¯­è¨€**: æ‰€æœ‰è®¾ç½®åŒºåŸŸé‡‡ç”¨ä¸€è‡´çš„è§†è§‰è®¾è®¡æ ‡å‡†
          - **ç»†èŠ‚æ‰“ç£¨**: ç²¾å¿ƒè°ƒæ•´çš„æ»šåŠ¨æ¡å®½åº¦ã€é¢œè‰²å’Œåœ†è§’è®¾è®¡
          - **ä¸»é¢˜é€‚é…**: å®Œç¾Žæ”¯æŒæ˜Žæš—ä¸»é¢˜ä¸‹çš„è§†è§‰æ•ˆæžœ
          
          ### äº¤äº’ä½“éªŒ
          - **æµç•…æ»šåŠ¨**: ä¼˜åŒ–çš„æ»šåŠ¨æ¡æ ·å¼æä¾›æ›´æµç•…çš„æ»šåŠ¨ä½“éªŒ
          - **è§†è§‰åé¦ˆ**: æ‚¬åœçŠ¶æ€æä¾›æ¸…æ™°çš„äº¤äº’åé¦ˆ
          - **ç©ºé—´ä¼˜åŒ–**: ç²¾ç®€çš„æ»šåŠ¨æ¡è®¾è®¡èŠ‚çœç•Œé¢ç©ºé—´
          
          ## ðŸ”„ å‡çº§è¯´æ˜Ž
          
          - **æ— ç¼å‡çº§**: å®Œå…¨å…¼å®¹çŽ°æœ‰é…ç½®å’Œæ•°æ®
          - **ç«‹å³ç”Ÿæ•ˆ**: å‡çº§åŽè®¾ç½®ç•Œé¢ç«‹å³åº”ç”¨æ–°çš„è§†è§‰æ ·å¼
          - **æ€§èƒ½æå‡**: ä¼˜åŒ–çš„ CSS å®žçŽ°æå‡ç•Œé¢æ¸²æŸ“æ€§èƒ½
          - **å‘åŽå…¼å®¹**: ä¿æŒæ‰€æœ‰çŽ°æœ‰åŠŸèƒ½å’Œé…ç½®ä¸å˜
          
          ## ðŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ MoliTodoï¼AI æ™ºèƒ½åŠŸèƒ½è®©ä»»åŠ¡ç®¡ç†æ›´åŠ é«˜æ•ˆä¾¿æ·ã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨ GitHub ä¸Šåé¦ˆã€‚
          EOF
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md