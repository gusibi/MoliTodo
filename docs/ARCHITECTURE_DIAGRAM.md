# MoliTodo 架构图

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              MoliTodo 应用架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Renderer Process (Vue 3)                        │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │   Components    │  │     Views       │  │      Pinia Store       │ │ │
│  │  │                 │  │                 │  │                         │ │ │
│  │  │ TaskManager.vue │  │  MainView.vue   │  │    taskStore.js         │ │ │
│  │  │ TaskPanel.vue   │  │ SettingsView.vue│  │  - getAllTasks()        │ │ │
│  │  │ FloatingIcon.vue│  │                 │  │  - createTask()         │ │ │
│  │  │ Settings.vue    │  │                 │  │  - updateTask()         │ │ │
│  │  └─────────────────┘  └─────────────────┘  │  - deleteTask()         │ │ │
│  │           │                     │          │  - startTask()          │ │ │
│  │           └─────────────────────┼──────────┤  - pauseTask()          │ │ │
│  │                                 │          └─────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                        Vue Router                                   │ │ │
│  │  │  /task-manager → TaskManager.vue                                    │ │ │
│  │  │  /task-panel   → TaskPanel.vue                                      │ │ │
│  │  │  /settings     → SettingsView.vue                                   │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                     │
│                                        │ window.electronAPI                  │
│                                        │ (IPC Communication)                 │
│                                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         Main Process (Node.js)                         │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                        Preload Script                              │ │ │
│  │  │                         preload.js                                 │ │ │
│  │  │  contextBridge.exposeInMainWorld('electronAPI', {                  │ │ │
│  │  │    tasks: { create, getAll, update, delete, ... },                 │ │ │
│  │  │    config: { get, update, save },                                  │ │ │
│  │  │    windows: { showTaskManager, showSettings, ... },                │ │ │
│  │  │    events: { on, off, removeAllListeners }                         │ │ │
│  │  │  })                                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  │                                        │                               │ │
│  │                                        │ ipcRenderer.invoke()          │ │
│  │                                        ▼                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                        IPC Handlers                                │ │ │
│  │  │                      ipc-handlers.js                               │ │ │
│  │  │  ipcMain.handle('create-task', async (event, taskData) => {        │ │ │
│  │  │    const task = await this.taskService.createTask(...)             │ │ │
│  │  │    this.broadcastTaskUpdates()                                     │ │ │
│  │  │    return { success: true, task }                                  │ │ │
│  │  │  })                                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  │                                        │                               │ │
│  │                                        │ this.taskService.method()     │ │
│  │                                        ▼                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                      Domain Services                               │ │ │
│  │  │                     task-service.js                                │ │ │
│  │  │  async createTask(content, reminderTime) {                         │ │ │
│  │  │    const task = new Task(id, content, 'todo', new Date(), ...)     │ │ │
│  │  │    return await this.taskRepository.save(task)                     │ │ │
│  │  │  }                                                                  │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  │                                        │                               │ │
│  │                                        │ this.taskRepository.save()    │ │
│  │                                        ▼                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                   Infrastructure Layer                             │ │ │
│  │  │                sqlite-task-repository.js                           │ │ │
│  │  │  async save(task) {                                                 │ │ │
│  │  │    const row = this.taskToRow(task)                                │ │ │
│  │  │    await this.db.run('INSERT INTO tasks (...) VALUES (...)', [...])│ │ │
│  │  │    return task                                                      │ │ │
│  │  │  }                                                                  │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                     │
│                                        │ SQL Operations                      │
│                                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                            SQLite Database                              │ │
│  │                              tasks.db                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                           tasks 表                                  │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │ id (TEXT PRIMARY KEY)                                           │ │ │ │
│  │  │  │ content (TEXT NOT NULL)                                         │ │ │ │
│  │  │  │ status (TEXT DEFAULT 'todo')                                    │ │ │ │
│  │  │  │ completed (INTEGER DEFAULT 0)                                   │ │ │ │
│  │  │  │ created_at (TEXT NOT NULL)                                      │ │ │ │
│  │  │  │ updated_at (TEXT NOT NULL)                                      │ │ │ │
│  │  │  │ reminder_time (TEXT)                                            │ │ │ │
│  │  │  │ completed_at (TEXT)                                             │ │ │ │
│  │  │  │ started_at (TEXT)                                               │ │ │ │
│  │  │  │ total_duration (INTEGER DEFAULT 0)                             │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流向详细图

### 创建任务流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  TaskManager    │    │   Pinia Store   │    │   electronAPI   │
│     .vue        │    │   taskStore.js  │    │   preload.js    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │ addTask()             │                       │
         ├──────────────────────►│                       │
         │                       │ createTask(data)      │
         │                       ├──────────────────────►│
         │                       │                       │ ipcRenderer.invoke
         │                       │                       │ ('create-task', data)
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  IPC Handlers   │    │ Domain Service  │    │ SQLite Repo     │
│ ipc-handlers.js │    │ task-service.js │    │sqlite-task-repo │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │◄──────────────────────┼───────────────────────┤
         │                       │                       │
         │ taskService.          │                       │
         │ createTask()          │                       │
         ├──────────────────────►│                       │
         │                       │ taskRepository.       │
         │                       │ save(task)            │
         │                       ├──────────────────────►│
         │                       │                       │ SQL INSERT
         │                       │                       ├─────────────┐
         │                       │                       │             │
         │                       │                       │             ▼
         │                       │                       │    ┌─────────────────┐
         │                       │                       │    │   SQLite DB     │
         │                       │                       │    │    tasks.db     │
         │                       │                       │    └─────────────────┘
         │                       │                       │
         │                       │◄──────────────────────┤
         │◄──────────────────────┤                       │
         │                       │                       │
         │ broadcastTaskUpdates()│                       │
         ├─────────────────────┐ │                       │
         │                     │ │                       │
         │                     ▼ │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   All Windows   │    │  Event: tasks-  │    │   Vue Components│
│   (broadcast)   │    │    updated      │    │   (re-render)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 实时数据同步机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            事件驱动的数据同步                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  数据变更 (任何窗口)                                                          │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────┐                                                        │
│  │  IPC Handlers   │                                                        │
│  │ broadcastTask   │                                                        │
│  │   Updates()     │                                                        │
│  └─────────────────┘                                                        │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                    发送 'tasks-updated' 事件                            │ │
│  │                      到所有活跃窗口                                      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │
│  │ Floating Window │  │ TaskManager     │  │    Settings Window          │ │
│  │                 │  │    Window       │  │                             │ │
│  │ FloatingIcon    │  │                 │  │                             │ │
│  │   .vue          │  │ TaskManager.vue │  │      Settings.vue           │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │
│         │                       │                         │                │
│         ▼                       ▼                         ▼                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │
│  │ 监听事件并       │  │ 监听事件并       │  │ 监听事件并                   │ │
│  │ 更新角标显示     │  │ 重新加载任务列表 │  │ 更新统计信息                 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 安全架构

### IPC 通信安全模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全边界                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Renderer Process                                 │ │
│  │                         (沙盒环境)                                       │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    Vue Application                                  │ │ │
│  │  │                                                                     │ │ │
│  │  │  只能访问 window.electronAPI                                         │ │ │
│  │  │  无法直接访问 Node.js API                                            │ │ │
│  │  │  无法直接访问文件系统                                                 │ │ │
│  │  │  无法直接访问系统资源                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                     │
│                                        │ 受限的 IPC 通信                      │
│                                        │ (仅预定义的 API)                     │
│                                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Preload Script                                  │ │
│  │                         (安全桥梁)                                       │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │              contextBridge.exposeInMainWorld()                      │ │ │
│  │  │                                                                     │ │ │
│  │  │  ✅ 只暴露安全的、预定义的 API                                        │ │ │
│  │  │  ✅ 验证所有传入参数                                                  │ │ │
│  │  │  ✅ 限制可访问的 IPC 通道                                             │ │ │
│  │  │  ❌ 不暴露原始的 ipcRenderer                                          │ │ │
│  │  │  ❌ 不暴露 Node.js 模块                                              │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                     │
│                                        │ 验证过的 IPC 调用                    │
│                                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         Main Process                                    │ │
│  │                        (完全权限)                                        │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                      IPC Handlers                                   │ │ │
│  │  │                                                                     │ │ │
│  │  │  ✅ 验证所有请求参数                                                  │ │ │
│  │  │  ✅ 实施业务逻辑验证                                                  │ │ │
│  │  │  ✅ 错误处理和日志记录                                                │ │ │
│  │  │  ✅ 访问控制和权限检查                                                │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 性能优化架构

### 数据缓存和更新策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            性能优化策略                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        前端缓存层                                        │ │
│  │                                                                         │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │   Pinia Store   │  │  Vue Reactive   │  │    Component Cache      │ │ │
│  │  │                 │  │     Data        │  │                         │ │ │
│  │  │ - tasks[]       │  │ - computed()    │  │ - v-memo               │ │ │
│  │  │ - loading       │  │ - watch()       │  │ - keep-alive           │ │ │
│  │  │ - filters       │  │ - ref/reactive  │  │ - lazy loading         │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                     │
│                                        │ 按需更新                             │
│                                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        IPC 优化层                                       │ │
│  │                                                                         │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │   批量操作       │  │   增量更新       │  │      事件防抖            │ │ │
│  │  │                 │  │                 │  │                         │ │ │
│  │  │ - 批量创建       │  │ - 只传输变更     │  │ - debounce 搜索         │ │ │
│  │  │ - 批量删除       │  │ - 差异计算       │  │ - throttle 滚动         │ │ │
│  │  │ - 批量更新       │  │ - 智能合并       │  │ - 延迟执行              │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                     │
│                                        │ 优化的数据操作                        │
│                                        ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       后端优化层                                         │ │
│  │                                                                         │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │   连接池         │  │   查询优化       │  │      索引策略            │ │ │
│  │  │                 │  │                 │  │                         │ │ │
│  │  │ - SQLite 连接   │  │ - 预编译语句     │  │ - 主键索引              │ │ │
│  │  │ - 连接复用       │  │ - 查询计划       │  │ - 状态索引              │ │ │
│  │  │ - 事务管理       │  │ - 结果缓存       │  │ - 时间索引              │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

这个架构图文档提供了 MoliTodo 应用的完整架构视图，包括：

1. **系统架构总览** - 展示各层之间的关系
2. **数据流向详细图** - 具体的数据传递过程
3. **实时数据同步机制** - 事件驱动的更新机制
4. **安全架构** - IPC 通信的安全边界
5. **性能优化架构** - 缓存和优化策略

这些图表可以帮助开发者快速理解系统架构，便于维护和扩展功能。